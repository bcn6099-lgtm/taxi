<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FacturaciÃ³ Taxi</title>
    <style>
        /* IMPORTACIÃ“N DE FUENTE GOOGLE FONTS - Nunito */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap');
        
        /* RESET GLOBAL */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* VARIABLES CSS */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #2a2a2a;
            --accent: #ffc107;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #404040;
            --color-green: #4caf50;
            --color-red: #ff4444;
            --color-yellow: #ffc107;
        }
        
        /* ESTILOS DEL BODY */
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* SIDEBAR MENU */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .menu-item {
            padding: 0.875rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }
        
        .menu-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .menu-item.active {
            background: var(--bg-card);
            color: var(--accent);
            border-left-color: var(--accent);
        }
        
        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }
        
        /* MENU TOGGLE */
        .menu-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }
        
        .menu-toggle span {
            width: 20px;
            height: 2px;
            background: var(--bg-primary);
            transition: all 0.3s;
        }
        
        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        /* MAIN CONTENT */
        .main-content {
            margin-left: 0;
            padding: 1rem;
            padding-top: 4rem;
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            .main-content {
                padding: 2rem;
                padding-top: 2rem;
            }
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-align: center;
        }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        /* CAMBIO: AlineaciÃ³n centrada para las tarjetas */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s;
            text-align: center; /* Centrado horizontal del texto */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrado de elementos flex */
            justify-content: center;
        }
        
        .stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .stat-change {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* CHART CONTAINER */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: center; /* Centrado del tÃ­tulo del grÃ¡fico */
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
            width: 100%;
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }
        
        canvas {
            max-height: 300px !important;
            width: 100% !important;
        }
        
        @media (min-width: 768px) {
            canvas {
                max-height: 400px !important;
            }
        }
        
        /* FILTERS */
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            justify-content: center; /* Centrado de filtros */
        }
        
        select, .filter-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        select:hover, .filter-btn:hover {
            border-color: var(--accent);
        }
        
        .filter-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        /* BUTTONS */
        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #ffca28;
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
        }
        
        .btn-danger {
            background: var(--color-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff6666;
        }
        
        /* TABLE */
        .table-container {
            overflow-x: auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-secondary);
        }
        
        th {
            padding: 0.875rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        td {
            padding: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        
        tbody tr:hover {
            background: rgba(255, 193, 7, 0.05);
        }

        .weekday-abbr {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
        }
        
        /* FORMULARIOS */
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-btn:hover {
            color: var(--text-primary);
        }
        
        /* ALERTS */
        .alert {
            padding: 0.875rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--color-green);
            border: 1px solid var(--color-green);
        }
        
        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            color: var(--color-red);
            border: 1px solid var(--color-red);
        }
        
        /* PAGES */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* LOADING */
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* MONTH LIST */
        .month-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .month-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .month-item:hover {
            border-color: var(--accent);
        }
        
        .month-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .month-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .month-revenue {
            font-weight: 700;
            color: var(--accent);
            font-size: 1.25rem;
        }
        
        .month-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .month-item.expanded .month-details {
            display: block;
        }
        
        .comparison-percentages {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .comparison-percentages span {
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .observation-alert {
            color: var(--accent);
            font-weight: 700;
            margin-left: 0.25rem;
            font-size: 1.2rem;
            vertical-align: middle;
        }
        
        .revenue-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* RANGE SLIDER */
        .range-slider-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .range-slider-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: block;
        }
        
        .range-slider-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .range-input {
            flex: 1;
        }
        
        .range-input label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .range-input select {
            width: 100%;
        }
        
        /* VIEW SELECTOR */
        .view-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .view-btn {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .view-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        /* UTILIDADES */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <span>Carregant dades...</span>
    </div>

    <button class="menu-toggle" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ðŸ“Š Taxi Control</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="navigateTo('dashboard')">ðŸ“ˆ Resum</div>
            <div class="menu-item" onclick="navigateTo('monthly')">ðŸ“… Per mesos</div>
            <div class="menu-item" onclick="navigateTo('historic')">ðŸ“‹ HistÃ²ric</div>
            <div class="menu-item" onclick="navigateTo('comparison')">ðŸ”„ Comparativa</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="navigateTo('add')">âž• Afegir dia</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="exportJSON()">ðŸ’¾ Exportar JSON</div>
            <div class="menu-item" onclick="document.getElementById('importFile').click()">ðŸ“‚ Importar JSON</div>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
        </div>
    </div>

    <div id="mainContent" style="display:none">
        <div class="main-content">
            
            <div id="dashboard" class="page active">
                <h1 class="page-title">ðŸ“ˆ Resum General</h1>
                
                <div class="filters">
                    <select id="monthFilter" onchange="updateDashboard()">
                        <option value="all">Tots els mesos</option>
                    </select>
                </div>

                <div class="stats-grid" id="statsGrid"></div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">EvoluciÃ³ d'ingressos</h3>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-label">Suma total d'ingressos</div>
                        <div class="stat-value" id="totalIngresosSum">0â‚¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Suma total de serveis</div>
                        <div class="stat-value" id="totalServiciosSum">0</div>
                    </div>
                </div>
            </div>

            <div id="monthly" class="page">
                <h1 class="page-title">ðŸ“… Vista per Mesos</h1>
                <div class="filters">
                    <select id="yearFilterMonthly" onchange="updateMonthlyView()">
                        <option value="all">Tots els anys</option>
                    </select>
                </div>
                <div class="month-list" id="monthList"></div>
                <div id="monthModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="monthModalTitle">Detalls del mes</h3>
                            <button class="close-btn" onclick="closeMonthModal()">&times;</button>
                        </div>
                        <div id="monthModalContent"></div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="navigateTo('add'); closeMonthModal();">Afegir dia a aquest mes</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historic" class="page">
                <h1 class="page-title">ðŸ“‹ HistÃ²ric</h1>
                <div class="view-selector">
                    <button class="view-btn" onclick="setHistoricView('days')">Per dies</button>
                    <button class="view-btn active" onclick="setHistoricView('months')">Per mesos</button>
                </div>
                <div class="range-slider-container">
                    <label class="range-slider-label">Selecciona el perÃ­ode temporal:</label>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="historicStartMonth" onchange="updateHistoricView()"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="historicEndMonth" onchange="updateHistoricView()"></select>
                        </div>
                    </div>
                </div>
                <div class="button-group mb-2">
                    <button class="btn btn-primary" onclick="exportToCSV()">Exportar CSV</button>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">GrÃ fic d'ingressos</h3>
                    </div>
                    <canvas id="historicChart"></canvas>
                </div>
                <div class="table-container" id="historicTableContainer"></div>
            </div>

            <div id="comparison" class="page">
                <h1 class="page-title">ðŸ”„ Comparativa</h1>
                <div class="range-slider-container">
                    <label class="range-slider-label">Selecciona el perÃ­ode temporal:</label>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="comparisonStartMonth" onchange="updateComparisonView()"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="comparisonEndMonth" onchange="updateComparisonView()"></select>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Ingressos per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartIngresos"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Mitjana diÃ ria per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartMediaDia"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Mitjana per hora per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartHora"></canvas>
                </div>
            </div>

            <div id="add" class="page">
                <h1 class="page-title">âž• Afegir / Editar Dia</h1>
                <div class="chart-container">
                    <div id="alertContainer"></div>
                    <form id="addDayForm" onsubmit="addNewDay(event, 'add')">
                        <div class="form-group">
                            <label for="fecha">Data:</label>
                            <input type="date" id="fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="ingresos">Ingressos (â‚¬):</label>
                            <input type="number" id="ingresos" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="servicios">Nombre de serveis:</label>
                            <input type="number" id="servicios" required>
                        </div>
                        <div class="form-group">
                            <label for="horas">Hores treballades (opcional):</label>
                            <input type="number" id="horas" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="observacions">Observacions (opcional):</label>
                            <textarea id="observacions"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Desar</button>
                    </form>
                </div>
                <h2 class="page-title" style="margin-top: 2rem;">Tots els dies</h2>
                <div class="table-container" id="allDaysTable"></div>
            </div>

        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar dia</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="alertContainerMonth"></div>
            <form id="addDayFormMonth" onsubmit="addNewDay(event, 'month')">
                <div class="form-group">
                    <label for="fechaMonth">Data:</label>
                    <input type="date" id="fechaMonth" required>
                </div>
                <div class="form-group">
                    <label for="ingresosMonth">Ingressos (â‚¬):</label>
                    <input type="number" id="ingresosMonth" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="serviciosMonth">Nombre de serveis:</label>
                    <input type="number" id="serviciosMonth" required>
                </div>
                <div class="form-group">
                    <label for="horasMonth">Hores treballades (opcional):</label>
                    <input type="number" id="horasMonth" step="0.1">
                </div>
                <div class="form-group">
                    <label for="observacionsMonth">Observacions (opcional):</label>
                    <textarea id="observacionsMonth"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Desar canvis</button>
                    <button type="button" class="btn btn-danger" onclick="deleteDay(currentEditDate)">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // GLOBAL VARIABLES
        let datosIniciales = [];
        let allData = [];
        let filteredData = [];
        let currentEditDate = null;
        let revenueChart = null;
        let comparisonChartIngresos = null;
        let comparisonChartMediaDia = null;
        let comparisonChartHora = null;
        let historicChart = null;
        let historicViewMode = 'months'; 

        const diasSemana = {
            'Monday': 'dl',
            'Tuesday': 'dm',
            'Wednesday': 'dc',
            'Thursday': 'dj',
            'Friday': 'dv',
            'Saturday': 'ds',
            'Sunday': 'du'
        };

        const monthNames = {
            '01': 'Gener', '02': 'Febrer', '03': 'MarÃ§', '04': 'Abril',
            '05': 'Maig', '06': 'Juny', '07': 'Juliol', '08': 'Agost',
            '09': 'Setembre', '10': 'Octubre', '11': 'Novembre', '12': 'Desembre'
        };

        // STORAGE FUNCTIONS
        function getStoredData() {
            try {
                const stored = localStorage.getItem('taxiData');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error reading storage:', error);
                return [];
            }
        }

        function saveToStorage(data) {
            try {
                localStorage.setItem('taxiData', JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to storage:', error);
                return false;
            }
        }

        function loadData() {
            const storedData = getStoredData();
            allData = storedData.length > 0 ? storedData : datosIniciales;
            filteredData = [...allData];
        }

        // NAVIGATION
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            sidebar.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');
            
            toggleMenu();

            if (page === 'monthly') updateMonthlyView();
            if (page === 'historic') updateHistoricView();
            if (page === 'comparison') updateComparisonView();
            if (page === 'add') updateAllDaysTable();
        }

        // FILTERS
        function populateYearFilters() {
            const years = [...new Set(allData.map(d => d.fecha.substring(0, 4)))].sort().reverse();
            const yearFilterMonthly = document.getElementById('yearFilterMonthly');
            yearFilterMonthly.innerHTML = '<option value="all">Tots els anys</option>';
            years.forEach(year => {
                yearFilterMonthly.innerHTML += `<option value="${year}">${year}</option>`;
            });

            const monthFilter = document.getElementById('monthFilter');
            const allMonths = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="all">Tots els mesos</option>';
            allMonths.forEach(mesAnio => {
                const [year, monthNum] = mesAnio.split('-');
                const monthName = monthNames[monthNum];
                monthFilter.innerHTML += `<option value="${mesAnio}">${monthName} ${year}</option>`;
            });
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (allMonths.includes(currentMonth)) {
                monthFilter.value = currentMonth;
            }

            populateMonthRangeSelectors('historic');
            populateMonthRangeSelectors('comparison');
        }

        function populateMonthRangeSelectors(view) {
            const months = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort();
            const startSelect = document.getElementById(view === 'historic' ? 'historicStartMonth' : 'comparisonStartMonth');
            const endSelect = document.getElementById(view === 'historic' ? 'historicEndMonth' : 'comparisonEndMonth');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            months.forEach((month, index) => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[monthNum];
                const label = `${monthName} ${year}`;
                startSelect.innerHTML += `<option value="${month}" ${index === 0 ? 'selected' : ''}>${label}</option>`;
                endSelect.innerHTML += `<option value="${month}" ${index === months.length - 1 ? 'selected' : ''}>${label}</option>`;
            });
        }

        // UTILITY FUNCTIONS
        function roundTo5Cents(value) {
            return Math.round(value * 20) / 20;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(value) {
            if (value >= 1000) {
                return Math.round(value) + 'â‚¬';
            }
            return value.toFixed(2) + 'â‚¬';
        }

        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100);
        }

        function getConditionalColor(value, min, max) {
            if (value <= min) return 'var(--color-red)';
            if (value >= max) return 'var(--color-green)';
            const ratio = (value - min) / (max - min);
            if (ratio < 0.5) {
                return `rgb(255, ${Math.round(193 * ratio * 2)}, 68)`;
            } else {
                return `rgb(${Math.round(255 - 179 * (ratio - 0.5) * 2)}, ${Math.round(193 + 82 * (ratio - 0.5) * 2)}, ${Math.round(7 + 73 * (ratio - 0.5) * 2)})`;
            }
        }

        // CAMBIO: LÃ­mite superior 6200
        function getMonthlyRevenueColor(value) {
            return getConditionalColor(value, 2500, 6700);
        }

        function getPositiveColor(percentage) {
            return 'var(--color-green)';
        }

        function getNegativeColor(percentage) {
            return 'var(--color-red)';
        }

        // DASHBOARD
        function updateDashboard() {
            const monthFilter = document.getElementById('monthFilter').value;
            let targetMonth = monthFilter;
            if (monthFilter === 'all') {
                const now = new Date();
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            // Helpers para calcular estadÃ­sticas de un mes especÃ­fico
            const getStats = (monthStr) => {
                const data = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === monthStr);
                const ingresos = data.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
                const servicios = data.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
                const horas = data.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
                const dias = data.length;
                return {
                    ingresos, servicios, horas, dias,
                    mediaDia: dias > 0 ? ingresos / dias : 0,
                    mediaServ: servicios > 0 ? ingresos / servicios : 0,
                    mediaHora: horas > 0 ? ingresos / horas : 0
                };
            };

            // EstadÃ­sticas del mes actual
            const currentStats = getStats(targetMonth);
            const proyeccion = currentStats.mediaDia * 21;

            // DefiniciÃ³n de fechas comparativas
            const [currentYearStr, currentMonthStr] = targetMonth.split('-');
            const currentYear = parseInt(currentYearStr);
            const currentMonthNum = parseInt(currentMonthStr);

            // 1. AÃ±o anterior (mismo mes)
            const prevYearMonth = `${currentYear - 1}-${currentMonthStr}`;
            
            // 2. Mes anterior (lÃ³gica para cambio de aÃ±o)
            let prevMonthDate = new Date(currentYear, currentMonthNum - 1 - 1, 1); // Mes 0-index
            const prevMonthStr = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;
            
            // 3. 2019 (mismo mes)
            const year2019Month = `2019-${currentMonthStr}`;

            // Obtener estadÃ­sticas de comparativas
            const prevYearStats = getStats(prevYearMonth);
            const prevMonthStats = getStats(prevMonthStr);
            const year2019Stats = getStats(year2019Month);

            // FunciÃ³n para generar HTML de comparativas
            const generateComparisonHTML = (currentVal, prevYearVal, prevMonthVal, year2019Val) => {
                const changePrevYear = calculateChange(currentVal, prevYearVal);
                const changePrevMonth = calculateChange(currentVal, prevMonthVal);
                const change2019 = calculateChange(currentVal, year2019Val);
                
                const formatChange = (val, label) => {
                    const color = val >= 0 ? getPositiveColor(val) : getNegativeColor(val);
                    const arrow = val >= 0 ? 'â–²' : 'â–¼';
                    // Solo mostramos si hay datos previos para comparar (valor > 0)
                    // Si estamos comparando con 0 (mes sin datos), suele dar Infinito o 0.
                    // Asumimos que si la media previa es 0, no mostramos comparaciÃ³n.
                    return `
                        <div class="stat-change" style="color: ${color}; font-weight: 600;">
                            ${arrow} ${Math.abs(val).toFixed(1)}% <small>(${label})</small>
                        </div>
                    `;
                };

                let html = '';
                if (prevYearVal > 0) html += formatChange(changePrevYear, 'Any anterior');
                if (prevMonthVal > 0) html += formatChange(changePrevMonth, 'Mes anterior');
                if (year2019Val > 0) html += formatChange(change2019, '2019');
                return html;
            };

            const mediaDiaColor = getConditionalColor(currentStats.mediaDia, 150, 300);
            const mediaHoraColor = getConditionalColor(currentStats.mediaHora, 15, 25);
            const proyeccionColor = getMonthlyRevenueColor(proyeccion);

            // CAMBIO: ConstrucciÃ³n del HTML con 3 comparativas
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Ingressos del mes</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(currentStats.ingresos))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per dia</div>
                    <div class="stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(currentStats.mediaDia))}</div>
                    ${generateComparisonHTML(currentStats.mediaDia, prevYearStats.mediaDia, prevMonthStats.mediaDia, year2019Stats.mediaDia)}
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per servei</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(currentStats.mediaServ))}</div>
                    ${generateComparisonHTML(currentStats.mediaServ, prevYearStats.mediaServ, prevMonthStats.mediaServ, year2019Stats.mediaServ)}
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per hora</div>
                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(roundTo5Cents(currentStats.mediaHora))}</div>
                    ${generateComparisonHTML(currentStats.mediaHora, prevYearStats.mediaHora, prevMonthStats.mediaHora, year2019Stats.mediaHora)}
                </div>
                <div class="stat-card">
                    <div class="stat-label">ProjecciÃ³ del mes (21 dies)</div>
                    <div class="stat-value" style="color: ${proyeccionColor}">${formatCurrency(roundTo5Cents(proyeccion))}</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Actualizar datos filtrados para el grÃ¡fico
            filteredData = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === targetMonth);
            
            const allTotalIngresos = allData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
            const allTotalServicios = allData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
            
            document.getElementById('totalIngresosSum').textContent = formatCurrency(roundTo5Cents(allTotalIngresos));
            document.getElementById('totalServiciosSum').textContent = allTotalServicios;

            updateRevenueChart();
        }

        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            const sortedData = [...filteredData].sort((a, b) => a.fecha.localeCompare(b.fecha));
            const labels = sortedData.map(d => formatDate(d.fecha));
            const data = sortedData.map(d => roundTo5Cents(d.ingresos_dia || 0));

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: data,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // MONTHLY VIEW
        function updateMonthlyView() {
            const yearFilter = document.getElementById('yearFilterMonthly').value;
            
            const monthlyData = {};
            allData.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (yearFilter === 'all' || mesAnio.startsWith(yearFilter)) {
                    if (!monthlyData[mesAnio]) {
                        monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                    }
                    monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                    monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                    monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                    monthlyData[mesAnio].dias += 1;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = '';
            sortedMonths.forEach(mesAnio => {
                const data = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                const currentYear = parseInt(year);
                const currentMonth = month;
                
                const prevYearMonth = `${currentYear - 1}-${currentMonth}`;
                const prevYearData = monthlyData[prevYearMonth];
                const prevYearIngresos = prevYearData ? prevYearData.ingresos : 0;
                const changePrevYear = calculateChange(data.ingresos, prevYearIngresos);
                
                const year2019Month = `2019-${currentMonth}`;
                const year2019Data = monthlyData[year2019Month];
                const year2019Ingresos = year2019Data ? year2019Data.ingresos : 0;
                const change2019 = calculateChange(data.ingresos, year2019Ingresos);
                
                const comparisons = `
                    <div class="comparison-percentages">
                        ${prevYearIngresos > 0 ? `<span style="color: ${changePrevYear >= 0 ? getPositiveColor(changePrevYear) : getNegativeColor(changePrevYear)}; font-weight: 600;">${changePrevYear >= 0 ? 'â–²' : 'â–¼'}${Math.abs(changePrevYear).toFixed(1)}% <small>(Any anterior)</small></span>` : ''}
                        ${year2019Ingresos > 0 ? `<span style="color: ${change2019 >= 0 ? getPositiveColor(change2019) : getNegativeColor(change2019)}; font-weight: 600;">${change2019 >= 0 ? 'â–²' : 'â–¼'}${Math.abs(change2019).toFixed(1)}% <small>(2019)</small></span>` : ''}
                    </div>
                `;
                
                const monthData = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === mesAnio);
                const totalIngresos = monthData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
                const totalServicios = monthData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
                const totalHoras = monthData.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
                
                const mediaDia = monthData.length > 0 ? totalIngresos / monthData.length : 0;
                const mediaServicio = totalServicios > 0 ? totalIngresos / totalServicios : 0;
                const mediaHora = totalHoras > 0 ? totalIngresos / totalHoras : 0;
                
                const mediaDiaColor = getConditionalColor(mediaDia, 150, 300);
                const mediaHoraColor = getConditionalColor(mediaHora, 15, 25);
                const monthRevenueColor = getMonthlyRevenueColor(totalIngresos);
                
                const observaciones = monthData
                    .filter(d => d.observacions && d.observacions.trim() !== '')
                    .map(d => `<li><strong>${formatDate(d.fecha)}:</strong> ${d.observacions}</li>`)
                    .join('');
                
                let daysHtml = '';
                monthData.sort((a, b) => b.fecha.localeCompare(a.fecha)).forEach(d => {
                    const date = new Date(d.fecha + 'T12:00:00');
                    const dayName = diasSemana[date.toLocaleDateString('en-US', { weekday: 'long' })];
                    const revenueColor = getConditionalColor(d.ingresos_dia || 0, 150, 300);
                    const hasObservations = d.observacions && d.observacions.trim() !== '';
                    
                    daysHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border); align-items: center;">
                            <div>
                                <strong>${formatDate(d.fecha)}</strong> - <span class="weekday-abbr">${dayName}</span>
                            </div>
                            <div style="text-align: right;">
                                <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(d.ingresos_dia || 0))}</span>
                                ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                                <button class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${d.fecha}'); event.stopPropagation();">âœï¸</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="month-item" onclick="toggleMonthDetails(event, '${mesAnio}')">
                        <div class="month-item-header">
                            <div>
                                <div class="month-name">${monthName} ${year}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${data.dias} dies Â· ${data.servicios} serveis
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="month-revenue" style="color: ${monthRevenueColor}">${formatCurrency(roundTo5Cents(data.ingresos))}</div>
                                ${comparisons}
                            </div>
                        </div>
                        <div class="month-details" id="details-${mesAnio}">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Total</div>
                                    <div class="stat-value">${formatCurrency(roundTo5Cents(totalIngresos))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Mitjana/dia</div>
                                    <div class="stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Serveis</div>
                                    <div class="stat-value">${totalServicios}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">â‚¬/servei</div>
                                    <div class="stat-value">${formatCurrency(roundTo5Cents(mediaServicio))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">â‚¬/hora</div>
                                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(roundTo5Cents(mediaHora))}</div>
                                </div>
                            </div>
                            ${observaciones ? `
                                <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Observacions:</h4>
                                <ul style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                                    ${observaciones}
                                </ul>
                            ` : ''}
                            <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Dies:</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${daysHtml}
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('monthList').innerHTML = html || '<p style="text-align:center; color: var(--text-secondary);">No hi ha dades disponibles</p>';
        }
        
        function toggleMonthDetails(event, mesAnio) {
            event.currentTarget.classList.toggle('expanded');
        }

        function closeMonthModal() {
            document.getElementById('monthModal').classList.remove('active');
        }

        // HISTORIC VIEW
        function setHistoricView(mode) {
            historicViewMode = mode;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateHistoricView();
        }

        function updateHistoricView() {
            const startMonth = document.getElementById('historicStartMonth').value;
            const endMonth = document.getElementById('historicEndMonth').value;
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });
            updateHistoricChart(filtered);
            if (historicViewMode === 'days') {
                updateHistoricTableDays(filtered);
            } else {
                updateHistoricTableMonths(filtered);
            }
        }

        function updateHistoricChart(data) {
            const ctx = document.getElementById('historicChart');
            let labels = [];
            let chartData = [];
            
            if (historicViewMode === 'days') {
                const sorted = [...data].sort((a, b) => a.fecha.localeCompare(b.fecha));
                labels = sorted.map(d => formatDate(d.fecha));
                chartData = sorted.map(d => roundTo5Cents(d.ingresos_dia || 0));
            } else {
                const monthlyData = {};
                data.forEach(d => {
                    const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                    if (!monthlyData[mesAnio]) {
                        monthlyData[mesAnio] = 0;
                    }
                    monthlyData[mesAnio] += d.ingresos_dia || 0;
                });
                const sorted = Object.keys(monthlyData).sort();
                labels = sorted.map(mesAnio => {
                    const [year, month] = mesAnio.split('-');
                    return `${monthNames[month]} ${year}`;
                });
                chartData = sorted.map(mesAnio => roundTo5Cents(monthlyData[mesAnio]));
            }

            if (historicChart) historicChart.destroy();
            historicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: chartData,
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateHistoricTableDays(data) {
            const sorted = [...data].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Ingressos</th>
                            <th>Observacions</th>
                            <th>â‚¬/Hora</th>
                            <th>Serveis</th>
                            <th>â‚¬/Servei</th>
                            <th>Hores</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                const revenueColor = getConditionalColor(row.ingresos_dia || 0, 150, 300);
                const hasObservations = row.observacions && row.observacions.trim() !== '';

                html += `
                    <tr>
                        <td>${formatDate(row.fecha)}</td>
                        <td class="weekday-abbr">${diaSemana}</td>
                        <td>
                            <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(row.ingresos_dia || 0))}</span>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${row.observacions || ''}">${row.observacions || '-'}</td>
                        <td>${row.horas_trabajadas ? formatCurrency(mediaHora) : '-'}</td>
                        <td>${row.servicios_dia || 0}</td>
                        <td>${formatCurrency(mediaPrecio)}</td>
                        <td>${row.horas_trabajadas ? row.horas_trabajadas.toFixed(1) : '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${row.fecha}')">âœï¸</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('historicTableContainer').innerHTML = html;
        }

        function updateHistoricTableMonths(data) {
            const monthlyData = {};
            const monthsWithObservations = new Set();
            
            data.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (!monthlyData[mesAnio]) {
                    monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                monthlyData[mesAnio].dias += 1;
                
                if (d.observacions && d.observacions.trim() !== '') {
                    monthsWithObservations.add(mesAnio);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Ingressos</th>
                            <th>Mitjana/dia</th>
                            <th>Mitjana/hora</th>
                            <th>â‚¬/Servei</th>
                            <th>Serveis</th>
                            <th>Dies</th>
                            <th>Hores</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMonths.forEach(mesAnio => {
                const mData = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                const mediaDia = mData.dias > 0 ? mData.ingresos / mData.dias : 0;
                const mediaServicio = mData.servicios > 0 ? mData.ingresos / mData.servicios : 0;
                const mediaHora = mData.horas > 0 ? mData.ingresos / mData.horas : 0;
                
                const mediaDiaColor = getConditionalColor(mediaDia, 50, 320);
                const mediaHoraColor = getConditionalColor(mediaHora, 10, 27);
                const monthRevenueColor = getMonthlyRevenueColor(mData.ingresos);
                const hasObservations = monthsWithObservations.has(mesAnio);

                html += `
                    <tr>
                        <td><strong>${monthName} ${year}</strong></td>
                        <td>
                            <strong style="color: ${monthRevenueColor}">${formatCurrency(roundTo5Cents(mData.ingresos))}</strong>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</td>
                        <td style="color: ${mediaHoraColor}">${mData.horas > 0 ? formatCurrency(roundTo5Cents(mediaHora)) : '-'}</td>
                        <td>${formatCurrency(roundTo5Cents(mediaServicio))}</td>
                        <td>${mData.servicios}</td>
                        <td>${mData.dias}</td>
                        <td>${mData.horas > 0 ? mData.horas.toFixed(1) : '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('historicTableContainer').innerHTML = html;
        }

        // COMPARISON VIEW
        function updateComparisonView() {
            const startMonth = document.getElementById('comparisonStartMonth').value;
            const endMonth = document.getElementById('comparisonEndMonth').value;
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            const yearlyData = {};
            filtered.forEach(d => {
                const year = d.fecha.substring(0, 4);
                const month = d.fecha.substring(5, 7);
                
                if (!yearlyData[year]) yearlyData[year] = {};
                if (!yearlyData[year][month]) {
                    yearlyData[year][month] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                
                yearlyData[year][month].ingresos += d.ingresos_dia || 0;
                yearlyData[year][month].servicios += d.servicios_dia || 0;
                yearlyData[year][month].horas += d.horas_trabajadas || 0;
                yearlyData[year][month].dias += 1;
            });

            const years = Object.keys(yearlyData).sort();
            const months = [...new Set(filtered.map(d => d.fecha.substring(5, 7)))].sort();
            const labels = months.map(m => monthNames[m]);

            updateComparisonChart('comparisonChartIngresos', 'Ingressos per mes', labels, years, yearlyData, 'ingresos');
            updateComparisonChart('comparisonChartMediaDia', 'Mitjana diÃ ria per mes', labels, years, yearlyData, 'mediaDia');
            updateComparisonChart('comparisonChartHora', 'â‚¬/Hora per mes', labels, years, yearlyData, 'hora');
        }

        function updateComparisonChart(canvasId, title, labels, years, yearlyData, metric) {
            const ctx = document.getElementById(canvasId);
            const colors = ['#ffc107', '#4caf50', '#2196f3', '#ff4444', '#9c27b0'];
            
            const datasets = years.map((year, index) => {
                const data = labels.map((label, idx) => {
                    const monthNum = Object.keys(monthNames).find(k => monthNames[k] === label);
                    const monthData = yearlyData[year][monthNum];
                    if (!monthData) return 0;
                    if (metric === 'ingresos') {
                        return roundTo5Cents(monthData.ingresos);
                    } else if (metric === 'mediaDia') {
                        return monthData.dias > 0 ? roundTo5Cents(monthData.ingresos / monthData.dias) : 0;
                    } else if (metric === 'hora') {
                        return monthData.horas > 0 ? roundTo5Cents(monthData.ingresos / monthData.horas) : 0;
                    }
                });
                return {
                    label: year,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            });

            let chart = null;
            if (canvasId === 'comparisonChartIngresos') chart = comparisonChartIngresos;
            else if (canvasId === 'comparisonChartMediaDia') chart = comparisonChartMediaDia;
            else if (canvasId === 'comparisonChartHora') chart = comparisonChartHora;
            
            if (chart) chart.destroy();

            const formatCallback = (value) => formatCurrency(value);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: ${formatCallback(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: formatCallback
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });

            if (canvasId === 'comparisonChartIngresos') comparisonChartIngresos = chart;
            else if (canvasId === 'comparisonChartMediaDia') comparisonChartMediaDia = chart;
            else if (canvasId === 'comparisonChartHora') comparisonChartHora = chart;
        }

        // MODAL & FORM FUNCTIONS
        function openEditModal(fecha) {
            const data = allData.find(d => d.fecha === fecha);
            if (!data) return;
            currentEditDate = fecha;
            document.getElementById('fechaMonth').value = fecha;
            document.getElementById('ingresosMonth').value = data.ingresos_dia || '';
            document.getElementById('serviciosMonth').value = data.servicios_dia || '';
            document.getElementById('horasMonth').value = data.horas_trabajadas || '';
            document.getElementById('observacionsMonth').value = data.observacions || '';
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditDate = null;
        }

        function addNewDay(event, source) {
            event.preventDefault();
            const fechaId = source === 'month' ? 'fechaMonth' : 'fecha';
            const ingresosId = source === 'month' ? 'ingresosMonth' : 'ingresos';
            const serviciosId = source === 'month' ? 'serviciosMonth' : 'servicios';
            const horasId = source === 'month' ? 'horasMonth' : 'horas';
            const observacionsId = source === 'month' ? 'observacionsMonth' : 'observacions';
            
            const fecha = document.getElementById(fechaId).value;
            const ingresos = parseFloat(document.getElementById(ingresosId).value);
            const servicios = parseInt(document.getElementById(serviciosId).value);
            const horas = parseFloat(document.getElementById(horasId).value) || null;
            const observacions = document.getElementById(observacionsId).value.trim() || null;
            
            const newEntry = {
                mes_anio: fecha.substring(0, 7),
                fecha: fecha,
                dia_semana: null,
                semana_num: null,
                ingresos_dia: ingresos,
                servicios_dia: servicios,
                media_precio_servicio: servicios > 0 ? ingresos / servicios : null,
                horas_trabajadas: horas,
                media_ingresos_hora: horas ? ingresos / horas : null,
                observacions: observacions
            };
            
            try {
                const storedData = getStoredData();
                const storedIndex = storedData.findIndex(d => d.fecha === fecha);
                if (storedIndex >= 0) {
                    storedData[storedIndex] = newEntry;
                    showAlert('Dia actualitzat correctament', 'success', source);
                } else {
                    storedData.push(newEntry);
                    showAlert('Dia afegit correctament', 'success', source);
                }
                if (saveToStorage(storedData)) {
                    loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    resetForm(source);
                    if (source === 'month') {
                        closeModal();
                        closeMonthModal();
                    }
                } else {
                    showAlert('Error en desar', 'error', source);
                }
            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Error en desar el dia', 'error', source);
            }
        }

        function resetForm(source) {
            if (source === 'month') {
                document.getElementById('addDayFormMonth').reset();
                document.getElementById('fechaMonth').valueAsDate = new Date();
            } else {
                document.getElementById('addDayForm').reset();
                document.getElementById('fecha').valueAsDate = new Date();
            }
        }

        function showAlert(message, type, source) {
            const containerId = source === 'month' ? 'alertContainerMonth' : 'alertContainer';
            const container = document.getElementById(containerId);
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function deleteDay(fecha) {
            if (!confirm(`EstÃ s segur que vols eliminar el dia ${formatDate(fecha)}?`)) return;
            try {
                const storedData = getStoredData();
                const filteredStorage = storedData.filter(d => d.fecha !== fecha);
                if (saveToStorage(filteredStorage)) {
                    loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    closeModal();
                    closeMonthModal();
                    showAlert('Dia eliminat correctament', 'success', 'add');
                } else {
                    showAlert('Error en eliminar el dia', 'error', 'add');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                showAlert('Error en eliminar el dia', 'error', 'add');
            }
        }

        function exportJSON() {
            const storedData = getStoredData();
            const dataStr = JSON.stringify(storedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facturacio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error('Format invÃ lid');
                    if (saveToStorage(importedData)) {
                        loadData();
                        populateYearFilters();
                        updateDashboard();
                        updateMonthlyView();
                        updateHistoricView();
                        updateAllDaysTable();
                        alert(`Dades importades: ${importedData.length} registres`);
                    } else {
                        alert('Error en desar les dades');
                    }
                } catch (error) {
                    console.error('Error importing:', error);
                    alert('Error en importar les dades');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportToCSV() {
            const startMonth = document.getElementById('historicStartMonth').value;
            const endMonth = document.getElementById('historicEndMonth').value;
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });
            const headers = ['Data', 'Dia', 'Ingressos', 'Serveis', 'â‚¬/Servei', 'Hores', 'â‚¬/Hora', 'Observacions'];
            const rows = filtered.map(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                return [
                    row.fecha,
                    diaSemana,
                    roundTo5Cents(row.ingresos_dia || 0),
                    row.servicios_dia || 0,
                    mediaPrecio.toFixed(2),
                    row.horas_trabajadas || '',
                    row.horas_trabajadas ? mediaHora.toFixed(2) : '',
                    row.observacions || ''
                ];
            });
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historic_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function initApp() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/rogerboullosa/facturacion/refs/heads/main/taxi_data_updated.json');
                datosIniciales = await response.json();
            } catch (error) {
                console.error('Error loading initial data:', error);
                datosIniciales = [];
            }
            loadData();
            populateYearFilters();
            updateDashboard();
            updateMonthlyView();
            updateHistoricView();
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaMonth').valueAsDate = new Date();
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }, 500);
        }

        initApp();
    </script>
</body>
</html>

