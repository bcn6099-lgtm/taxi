<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturaci√≥ Taxi</title>
    <style>
        /* IMPORTACI√ìN DE FUENTE GOOGLE FONTS - Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* RESET GLOBAL - Elimina m√°rgenes, padding y establece box-sizing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* VARIABLES CSS - Colores del tema oscuro */
        :root {
            --bg-primary: #000000;        /* Fondo principal negro */
            --bg-secondary: #1a1a1a;      /* Fondo secundario gris oscuro */
            --bg-card: #2a2a2a;           /* Fondo de tarjetas gris medio */
            --accent: #ffc107;            /* Color de acento amarillo */
            --text-primary: #ffffff;      /* Texto principal blanco */
            --text-secondary: #b0b0b0;    /* Texto secundario gris claro */
            --border: #404040;            /* Color de bordes gris */
            --color-green: #4caf50;       /* Color verde para positivos */
            --color-red: #ff4444;         /* Color rojo para negativos */
            --color-yellow: #ffc107;      /* Color amarillo para valores medios */
        }
        
        /* ESTILOS DEL BODY - Fuente, fondo y color de texto principal */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        /* SIDEBAR MENU - Men√∫ lateral fijo */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);        /* Oculto por defecto */
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        /* SIDEBAR ACTIVO - Men√∫ visible */
        .sidebar.active {
            transform: translateX(0);
        }
        
        /* CABECERA DEL SIDEBAR */
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        /* T√çTULO DEL SIDEBAR */
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        /* CONTENEDOR DEL MEN√ö */
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        /* ITEMS DEL MEN√ö */
        .menu-item {
            padding: 0.875rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }
        
        /* ITEM DEL MEN√ö AL PASAR EL RAT√ìN */
        .menu-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        /* ITEM DEL MEN√ö ACTIVO */
        .menu-item.active {
            background: var(--bg-card);
            color: var(--accent);
            border-left-color: var(--accent);
        }
        
        /* DIVISOR ENTRE ITEMS DEL MEN√ö */
        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }
        
        /* BOT√ìN TOGGLE DEL MEN√ö M√ìVIL - Hamburguesa */
        .menu-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }
        
        /* L√çNEAS DEL ICONO HAMBURGUESA */
        .menu-toggle span {
            width: 20px;
            height: 2px;
            background: var(--bg-primary);
            transition: all 0.3s;
        }
        
        /* ANIMACI√ìN DEL ICONO CUANDO EL MEN√ö EST√Å ACTIVO */
        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        /* CONTENIDO PRINCIPAL - √Årea de contenido a la derecha del men√∫ */
        .main-content {
            margin-left: 0;
            padding: 1rem;
            padding-top: 4rem;
            min-height: 100vh;
        }
        
        /* CONTENIDO PRINCIPAL EN TABLETS Y ESCRITORIO */
        @media (min-width: 768px) {
            .main-content {
                padding: 2rem;
                padding-top: 2rem;
            }
        }
        
        /* T√çTULO DE LA P√ÅGINA - Centrado */
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-align: center;           /* Alineaci√≥n centrada del t√≠tulo */
        }
        
        /* GRID DE ESTAD√çSTICAS - Cuadr√≠cula responsive para tarjetas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        /* TARJETA DE ESTAD√çSTICA */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s;
        }
        
        /* TARJETA DE ESTAD√çSTICA AL PASAR EL RAT√ìN */
        .stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        /* TARJETA CLICKEABLE */
        .stat-card.clickable {
            cursor: pointer;
        }
        
        /* ETIQUETA DE LA ESTAD√çSTICA */
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        /* VALOR DE LA ESTAD√çSTICA */
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        /* CAMBIO/PORCENTAJE DE LA ESTAD√çSTICA */
        .stat-change {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* CAMBIO POSITIVO - Verde */
        .stat-change.positive {
            color: var(--color-green);
        }
        
        /* CAMBIO NEGATIVO - Rojo */
        .stat-change.negative {
            color: var(--color-red);
        }
        
        /* CONTENEDOR DE GR√ÅFICOS */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        /* CABECERA DEL GR√ÅFICO */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        /* T√çTULO DEL GR√ÅFICO */
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* CANVAS DE LOS GR√ÅFICOS - Altura m√°xima en m√≥vil */
        canvas {
            max-height: 300px !important;
            width: 100% !important;
        }
        
        /* CANVAS EN TABLETS Y ESCRITORIO */
        @media (min-width: 768px) {
            canvas {
                max-height: 400px !important;
            }
        }
        
        /* FILTROS Y SELECTORES */
        .filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        /* SELECT Y BOTONES DE FILTRO */
        select, .filter-btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        /* SELECT Y BOTONES AL PASAR EL RAT√ìN */
        select:hover, .filter-btn:hover {
            border-color: var(--accent);
        }
        
        /* BOT√ìN DE FILTRO ACTIVO */
        .filter-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        /* GRUPO DE BOTONES */
        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        /* BOTONES */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        /* BOT√ìN PRIMARIO - Amarillo */
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #ffca28;
        }
        
        /* BOT√ìN SECUNDARIO - Gris */
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
        }
        
        /* BOT√ìN DE PELIGRO - Rojo */
        .btn-danger {
            background: var(--color-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff6666;
        }
        
        /* TABLA RESPONSIVE */
        .table-container {
            overflow-x: auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        
        /* TABLA */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        /* CABECERA DE LA TABLA */
        thead {
            background: var(--bg-secondary);
        }
        
        /* CELDAS DE LA CABECERA */
        th {
            padding: 0.875rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* CELDAS DEL CUERPO */
        td {
            padding: 0.875rem;
            border-bottom: 1px solid var(--border);
        }
        
        /* FILA AL PASAR EL RAT√ìN */
        tbody tr:hover {
            background: rgba(255, 193, 7, 0.05);
        }
        
        /* FORMULARIOS */
        .form-group {
            margin-bottom: 1rem;
        }
        
        /* ETIQUETA DEL FORMULARIO */
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* INPUTS Y TEXTAREAS */
        input, textarea {
            width: 100%;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        /* INPUTS AL ENFOCARSE */
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        /* TEXTAREA */
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        /* MODAL ACTIVO */
        .modal.active {
            display: flex;
        }
        
        /* CONTENIDO DEL MODAL */
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* CABECERA DEL MODAL */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        /* T√çTULO DEL MODAL */
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        /* BOT√ìN DE CERRAR MODAL */
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .close-btn:hover {
            color: var(--text-primary);
        }
        
        /* ALERTAS */
        .alert {
            padding: 0.875rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* ALERTA DE √âXITO */
        .alert-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--color-green);
            border: 1px solid var(--color-green);
        }
        
        /* ALERTA DE ERROR */
        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            color: var(--color-red);
            border: 1px solid var(--color-red);
        }
        
        /* P√ÅGINAS - Ocultas por defecto */
        .page {
            display: none;
        }
        
        /* P√ÅGINA ACTIVA */
        .page.active {
            display: block;
        }
        
        /* PANTALLA DE CARGA */
        #loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
            color: var(--accent);
        }
        
        /* SPINNER DE CARGA */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        /* ANIMACI√ìN DEL SPINNER */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* PESTA√ëAS */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }
        
        /* BOT√ìN DE PESTA√ëA */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        /* PESTA√ëA AL PASAR EL RAT√ìN */
        .tab-btn:hover {
            color: var(--text-primary);
        }
        
        /* PESTA√ëA ACTIVA */
        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        /* CONTENIDO DE PESTA√ëA - Oculto por defecto */
        .tab-content {
            display: none;
        }
        
        /* CONTENIDO DE PESTA√ëA ACTIVA */
        .tab-content.active {
            display: block;
        }
        
        /* LISTA DE MESES - Vista de l√≠neas en lugar de cuadr√≠cula */
        .month-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* ITEM DE MES - L√≠nea individual por mes */
        .month-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .month-item:hover {
            border-color: var(--accent);
        }
        
        .month-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* NOMBRE DEL MES */
        .month-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        /* INGRESOS DEL MES */
        .month-revenue {
            font-weight: 700;
            color: var(--accent);
            font-size: 1.25rem;
        }
        
        /* CONTENIDO DESPLEGABLE DEL MES */
        .month-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .month-item.expanded .month-details {
            display: block;
        }
        
        /* PORCENTAJES COMPARATIVOS - Debajo de ingresos totales */
        .comparison-percentages {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .comparison-percentages span {
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        /* ASTERISCO DE ALERTA PARA OBSERVACIONES */
        .observation-alert {
            color: var(--accent);
            font-weight: 700;
            margin-left: 0.25rem;
        }
        
        /* CIFRA DE INGRESOS CON TAMA√ëO MAYOR */
        .revenue-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* SELECTOR HORIZONTAL TIPO BARRA - Para Historic y Comparativa */
        .range-slider-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .range-slider-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: block;
        }
        
        .range-slider {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            position: relative;
            margin-bottom: 1rem;
        }
        
        .range-slider-track {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            position: absolute;
        }
        
        .range-slider-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .range-input {
            flex: 1;
        }
        
        .range-input label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .range-input select {
            width: 100%;
        }
        
        /* SELECTOR DE VISTA D√çAS/MESES EN HISTORIC */
        .view-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .view-btn {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .view-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        /* UTILIDADES */
        .text-center {
            text-align: center;
        }
        
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="loading">
        <div class="spinner"></div>
        <span>Carregant dades...</span>
    </div>

    <!-- MENU TOGGLE BUTTON -->
    <button class="menu-toggle" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üìä Taxi Control</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="navigateTo('dashboard')">üìà Resum</div>
            <div class="menu-item" onclick="navigateTo('monthly')">üìÖ Per mesos</div>
            <div class="menu-item" onclick="navigateTo('historic')">üìã Hist√≤ric</div>
            <div class="menu-item" onclick="navigateTo('comparison')">üîÑ Comparativa</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="navigateTo('add')">‚ûï Afegir dia</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="exportJSON()">üíæ Exportar JSON</div>
            <div class="menu-item" onclick="document.getElementById('importFile').click()">üìÇ Importar JSON</div>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="mainContent" style="display:none">
        <div class="main-content">
            
            <!-- DASHBOARD PAGE -->
            <div id="dashboard" class="page active">
                <h1 class="page-title">üìà Resum General</h1>
                
                <div class="filters">
                    <select id="monthFilter" onchange="updateDashboard()">
                        <option value="all">Tots els mesos</option>
                    </select>
                </div>

                <div class="stats-grid" id="statsGrid"></div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Evoluci√≥ d'ingressos</h3>
                    </div>
                    <canvas id="revenueChart"></canvas>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-label">Suma total d'ingressos</div>
                        <div class="stat-value" id="totalIngresosSum">0‚Ç¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Suma total de serveis</div>
                        <div class="stat-value" id="totalServiciosSum">0</div>
                    </div>
                </div>
            </div>

            <!-- MONTHLY PAGE -->
            <div id="monthly" class="page">
                <h1 class="page-title">üìÖ Vista per Mesos</h1>
                
                <div class="filters">
                    <select id="yearFilterMonthly" onchange="updateMonthlyView()">
                        <option value="all">Tots els anys</option>
                    </select>
                </div>

                <div class="month-list" id="monthList"></div>

                <!-- MODAL FOR MONTH DETAILS -->
                <div id="monthModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="monthModalTitle">Detalls del mes</h3>
                            <button class="close-btn" onclick="closeMonthModal()">&times;</button>
                        </div>
                        <div id="monthModalContent"></div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="navigateTo('add'); closeMonthModal();">Afegir dia a aquest mes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORIC PAGE -->
            <div id="historic" class="page">
                <h1 class="page-title">üìã Hist√≤ric</h1>
                
                <!-- SELECTOR DE VISTA: D√çAS O MESES -->
                <div class="view-selector">
                    <button class="view-btn active" onclick="setHistoricView('days')">Per dies</button>
                    <button class="view-btn" onclick="setHistoricView('months')">Per mesos</button>
                </div>
                
                <!-- SELECTOR HORIZONTAL DE RANGO DE FECHAS -->
                <div class="range-slider-container">
                    <label class="range-slider-label">Selecciona el per√≠ode temporal:</label>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="historicStartMonth" onchange="updateHistoricView()"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="historicEndMonth" onchange="updateHistoricView()"></select>
                        </div>
                    </div>
                </div>

                <div class="button-group mb-2">
                    <button class="btn btn-primary" onclick="exportToCSV()">Exportar CSV</button>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Gr√†fic d'ingressos</h3>
                    </div>
                    <canvas id="historicChart"></canvas>
                </div>

                <div class="table-container" id="historicTableContainer"></div>
            </div>

            <!-- COMPARISON PAGE -->
            <div id="comparison" class="page">
                <h1 class="page-title">üîÑ Comparativa</h1>
                
                <!-- SELECTOR HORIZONTAL DE RANGO DE FECHAS -->
                <div class="range-slider-container">
                    <label class="range-slider-label">Selecciona el per√≠ode temporal:</label>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="comparisonStartMonth" onchange="updateComparisonView()"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="comparisonEndMonth" onchange="updateComparisonView()"></select>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Ingressos per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartIngresos"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Mitjana di√†ria per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartMediaDia"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Mitjana per hora per mesos de tots els anys</h3>
                    </div>
                    <canvas id="comparisonChartHora"></canvas>
                </div>
            </div>

            <!-- ADD DAY PAGE -->
            <div id="add" class="page">
                <h1 class="page-title">‚ûï Afegir / Editar Dia</h1>
                
                <div class="chart-container">
                    <div id="alertContainer"></div>
                    <form id="addDayForm" onsubmit="addNewDay(event, 'add')">
                        <div class="form-group">
                            <label for="fecha">Data:</label>
                            <input type="date" id="fecha" required>
                        </div>
                        <div class="form-group">
                            <label for="ingresos">Ingressos (‚Ç¨):</label>
                            <input type="number" id="ingresos" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="servicios">Nombre de serveis:</label>
                            <input type="number" id="servicios" required>
                        </div>
                        <div class="form-group">
                            <label for="horas">Hores treballades (opcional):</label>
                            <input type="number" id="horas" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="observacions">Observacions (opcional):</label>
                            <textarea id="observacions"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Desar</button>
                    </form>
                </div>

                <h2 class="page-title" style="margin-top: 2rem;">Tots els dies</h2>
                <div class="table-container" id="allDaysTable"></div>
            </div>

        </div>
    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar dia</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="alertContainerMonth"></div>
            <form id="addDayFormMonth" onsubmit="addNewDay(event, 'month')">
                <div class="form-group">
                    <label for="fechaMonth">Data:</label>
                    <input type="date" id="fechaMonth" required>
                </div>
                <div class="form-group">
                    <label for="ingresosMonth">Ingressos (‚Ç¨):</label>
                    <input type="number" id="ingresosMonth" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="serviciosMonth">Nombre de serveis:</label>
                    <input type="number" id="serviciosMonth" required>
                </div>
                <div class="form-group">
                    <label for="horasMonth">Hores treballades (opcional):</label>
                    <input type="number" id="horasMonth" step="0.1">
                </div>
                <div class="form-group">
                    <label for="observacionsMonth">Observacions (opcional):</label>
                    <textarea id="observacionsMonth"></textarea>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Desar canvis</button>
                    <button type="button" class="btn btn-danger" onclick="deleteDay(currentEditDate)">Eliminar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // GLOBAL VARIABLES
        let datosIniciales = [];
        let allData = [];
        let filteredData = [];
        let currentEditDate = null;
        let revenueChart = null;
        let weekdayChart = null;
        let comparisonChartIngresos = null;
        let comparisonChartMediaDia = null;
        let comparisonChartHora = null;
        let historicChart = null;
        let historicViewMode = 'days'; // 'days' o 'months'

        const diasSemana = {
            'Monday': 'Dilluns',
            'Tuesday': 'Dimarts',
            'Wednesday': 'Dimecres',
            'Thursday': 'Dijous',
            'Friday': 'Divendres',
            'Saturday': 'Dissabte',
            'Sunday': 'Diumenge'
        };

        const monthNames = {
            '01': 'Gener', '02': 'Febrer', '03': 'Mar√ß', '04': 'Abril',
            '05': 'Maig', '06': 'Juny', '07': 'Juliol', '08': 'Agost',
            '09': 'Setembre', '10': 'Octubre', '11': 'Novembre', '12': 'Desembre'
        };

        // STORAGE FUNCTIONS
        function getStoredData() {
            try {
                const stored = localStorage.getItem('taxiData');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error reading storage:', error);
                return [];
            }
        }

        function saveToStorage(data) {
            try {
                localStorage.setItem('taxiData', JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to storage:', error);
                return false;
            }
        }

        function loadData() {
            const storedData = getStoredData();
            allData = storedData.length > 0 ? storedData : datosIniciales;
            filteredData = [...allData];
        }

        // NAVIGATION
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            sidebar.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');
            
            toggleMenu();

            if (page === 'monthly') updateMonthlyView();
            if (page === 'historic') updateHistoricView();
            if (page === 'comparison') updateComparisonView();
            if (page === 'add') updateAllDaysTable();
        }

        // FILTERS
        function populateYearFilters() {
            const years = [...new Set(allData.map(d => d.fecha.substring(0, 4)))].sort().reverse();
            
            const yearFilterMonthly = document.getElementById('yearFilterMonthly');
            
            yearFilterMonthly.innerHTML = '<option value="all">Tots els anys</option>';
            
            years.forEach(year => {
                yearFilterMonthly.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // Populate month filter with Mes A√±o format
            const monthFilter = document.getElementById('monthFilter');
            const allMonths = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort().reverse();
            
            monthFilter.innerHTML = '<option value="all">Tots els mesos</option>';
            allMonths.forEach(mesAnio => {
                const [year, monthNum] = mesAnio.split('-');
                const monthName = monthNames[monthNum];
                monthFilter.innerHTML += `<option value="${mesAnio}">${monthName} ${year}</option>`;
            });
            
            // Select current month
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (allMonths.includes(currentMonth)) {
                monthFilter.value = currentMonth;
            }

            // Populate month range selectors for Historic
            populateMonthRangeSelectors('historic');
            
            // Populate month range selectors for Comparison
            populateMonthRangeSelectors('comparison');
        }

        function populateMonthRangeSelectors(view) {
            const months = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort();
            
            const startSelect = document.getElementById(view === 'historic' ? 'historicStartMonth' : 'comparisonStartMonth');
            const endSelect = document.getElementById(view === 'historic' ? 'historicEndMonth' : 'comparisonEndMonth');
            
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            
            months.forEach((month, index) => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[monthNum];
                const label = `${monthName} ${year}`;
                
                startSelect.innerHTML += `<option value="${month}" ${index === 0 ? 'selected' : ''}>${label}</option>`;
                endSelect.innerHTML += `<option value="${month}" ${index === months.length - 1 ? 'selected' : ''}>${label}</option>`;
            });
        }

        // UTILITY FUNCTIONS
        function roundTo5Cents(value) {
            return Math.round(value * 20) / 20;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(value) {
            // Si el valor es 1000 o mayor, no mostrar decimales
            if (value >= 1000) {
                return Math.round(value) + '‚Ç¨';
            }
            return value.toFixed(2) + '‚Ç¨';
        }

        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100);
        }

        // FUNCI√ìN PARA OBTENER COLOR CONDICIONAL BASADO EN VALOR
        function getConditionalColor(value, min, max) {
            if (value <= min) return 'var(--color-red)';
            if (value >= max) return 'var(--color-green)';
            
            // Interpolaci√≥n entre rojo y verde pasando por amarillo
            const ratio = (value - min) / (max - min);
            if (ratio < 0.5) {
                // De rojo a amarillo
                return `rgb(255, ${Math.round(193 * ratio * 2)}, 68)`;
            } else {
                // De amarillo a verde
                return `rgb(${Math.round(255 - 179 * (ratio - 0.5) * 2)}, ${Math.round(193 + 82 * (ratio - 0.5) * 2)}, ${Math.round(7 + 73 * (ratio - 0.5) * 2)})`;
            }
        }

        // DASHBOARD
        function updateDashboard() {
            const monthFilter = document.getElementById('monthFilter').value;

            // Si no hay filtro, usar el mes actual
            let targetMonth = monthFilter;
            if (monthFilter === 'all') {
                const now = new Date();
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            filteredData = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio === targetMonth;
            });

            const totalIngresos = filteredData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
            const totalServicios = filteredData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
            const totalHoras = filteredData.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
            
            const mediaDia = filteredData.length > 0 ? totalIngresos / filteredData.length : 0;
            const mediaServicio = totalServicios > 0 ? totalIngresos / totalServicios : 0;
            const mediaHora = totalHoras > 0 ? totalIngresos / totalHoras : 0;
            const proyeccion = mediaDia * 21;

            // C√°lculo de cambios comparativos con el a√±o anterior
            const [currentYear, currentMonth] = targetMonth.split('-');
            const previousYearMonth = `${parseInt(currentYear) - 1}-${currentMonth}`;
            const previousYearData = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio === previousYearMonth;
            });

            const prevTotalIngresos = previousYearData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
            const prevMediaDia = previousYearData.length > 0 ? prevTotalIngresos / previousYearData.length : 0;
            const changeMediaDia = calculateChange(mediaDia, prevMediaDia);
            
            const prevTotalServicios = previousYearData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
            const prevMediaServicio = prevTotalServicios > 0 ? prevTotalIngresos / prevTotalServicios : 0;
            const changeMediaServicio = calculateChange(mediaServicio, prevMediaServicio);
            
            const prevTotalHoras = previousYearData.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
            const prevMediaHora = prevTotalHoras > 0 ? prevTotalIngresos / prevTotalHoras : 0;
            const changeMediaHora = calculateChange(mediaHora, prevMediaHora);

            // Get conditional colors for media dia and media hora (150->200 y 15->23)
            const mediaDiaColor = getConditionalColor(mediaDia, 150, 200);
            const mediaHoraColor = getConditionalColor(mediaHora, 15, 23);

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Ingressos del mes</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(totalIngresos))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per dia</div>
                    <div class="stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</div>
                    <div class="stat-change ${changeMediaDia >= 0 ? 'positive' : 'negative'}">
                        ${changeMediaDia >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(changeMediaDia).toFixed(1)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per servei</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(mediaServicio))}</div>
                    <div class="stat-change ${changeMediaServicio >= 0 ? 'positive' : 'negative'}">
                        ${changeMediaServicio >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(changeMediaServicio).toFixed(1)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per hora</div>
                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(roundTo5Cents(mediaHora))}</div>
                    <div class="stat-change ${changeMediaHora >= 0 ? 'positive' : 'negative'}">
                        ${changeMediaHora >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(changeMediaHora).toFixed(1)}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Projecci√≥ del mes (21 dies)</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(proyeccion))}</div>
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            // Update totals below chart
            document.getElementById('totalIngresosSum').textContent = formatCurrency(roundTo5Cents(totalIngresos));
            document.getElementById('totalServiciosSum').textContent = totalServicios;

            updateRevenueChart();
        }

        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            
            const sortedData = [...filteredData].sort((a, b) => a.fecha.localeCompare(b.fecha));
            const labels = sortedData.map(d => formatDate(d.fecha));
            const data = sortedData.map(d => roundTo5Cents(d.ingresos_dia || 0));

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: data,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // MONTHLY VIEW
        function updateMonthlyView() {
            const yearFilter = document.getElementById('yearFilterMonthly').value;
            
            const monthlyData = {};
            allData.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (yearFilter === 'all' || mesAnio.startsWith(yearFilter)) {
                    if (!monthlyData[mesAnio]) {
                        monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                    }
                    monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                    monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                    monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                    monthlyData[mesAnio].dias += 1;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = '';
            sortedMonths.forEach(mesAnio => {
                const data = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                // Calcular porcentajes comparativos
                const currentYear = parseInt(year);
                const currentMonth = month;
                
                // Comparar con el mismo mes del a√±o anterior
                const prevYearMonth = `${currentYear - 1}-${currentMonth}`;
                const prevYearData = monthlyData[prevYearMonth];
                const prevYearIngresos = prevYearData ? prevYearData.ingresos : 0;
                const changePrevYear = calculateChange(data.ingresos, prevYearIngresos);
                
                // Comparar con el mismo mes de 2019
                const year2019Month = `2019-${currentMonth}`;
                const year2019Data = monthlyData[year2019Month];
                const year2019Ingresos = year2019Data ? year2019Data.ingresos : 0;
                const change2019 = calculateChange(data.ingresos, year2019Ingresos);
                
                const comparisons = `
                    <div class="comparison-percentages">
                        ${prevYearIngresos > 0 ? `<span>${changePrevYear >= 0 ? '‚ñ≤' : '‚ñº'}${Math.abs(changePrevYear).toFixed(1)}% <small>(Any anterior)</small></span>` : ''}
                        ${year2019Ingresos > 0 ? `<span>${change2019 >= 0 ? '‚ñ≤' : '‚ñº'}${Math.abs(change2019).toFixed(1)}% <small>(2019)</small></span>` : ''}
                    </div>
                `;
                
                // Get month data details
                const monthData = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === mesAnio);
                const totalIngresos = monthData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
                const totalServicios = monthData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
                const totalHoras = monthData.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
                
                const mediaDia = monthData.length > 0 ? totalIngresos / monthData.length : 0;
                const mediaServicio = totalServicios > 0 ? totalIngresos / totalServicios : 0;
                const mediaHora = totalHoras > 0 ? totalIngresos / totalHoras : 0;
                
                const mediaDiaColor = getConditionalColor(mediaDia, 150, 200);
                const mediaHoraColor = getConditionalColor(mediaHora, 15, 23);
                
                let daysHtml = '';
                monthData.sort((a, b) => b.fecha.localeCompare(a.fecha)).forEach(d => {
                    const date = new Date(d.fecha + 'T12:00:00');
                    const dayName = diasSemana[date.toLocaleDateString('en-US', { weekday: 'long' })];
                    const revenueColor = getConditionalColor(d.ingresos_dia || 0, 150, 200);
                    const hasObservations = d.observacions && d.observacions.trim() !== '';
                    
                    daysHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border); align-items: center;">
                            <div>
                                <strong>${formatDate(d.fecha)}</strong> - ${dayName}
                            </div>
                            <div style="text-align: right;">
                                <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(d.ingresos_dia || 0))}</span>
                                ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                                <button class="btn btn-secondary" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${d.fecha}'); event.stopPropagation();">‚úèÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div class="month-item" onclick="toggleMonthDetails(event, '${mesAnio}')">
                        <div class="month-item-header">
                            <div>
                                <div class="month-name">${monthName} ${year}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${data.dias} dies ¬∑ ${data.servicios} serveis
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div class="month-revenue">${formatCurrency(roundTo5Cents(data.ingresos))}</div>
                                ${comparisons}
                            </div>
                        </div>
                        <div class="month-details" id="details-${mesAnio}">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-label">Total</div>
                                    <div class="stat-value">${formatCurrency(roundTo5Cents(totalIngresos))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Mitjana/dia</div>
                                    <div class="stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Serveis</div>
                                    <div class="stat-value">${totalServicios}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">‚Ç¨/servei</div>
                                    <div class="stat-value">${formatCurrency(roundTo5Cents(mediaServicio))}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">‚Ç¨/hora</div>
                                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(roundTo5Cents(mediaHora))}</div>
                                </div>
                            </div>
                            <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Dies:</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${daysHtml}
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('monthList').innerHTML = html || '<p style="text-align:center; color: var(--text-secondary);">No hi ha dades disponibles</p>';
        }
        
        function toggleMonthDetails(event, mesAnio) {
            event.currentTarget.classList.toggle('expanded');
        }

        function showMonthDetails(mesAnio) {
            // Esta funci√≥n ya no se usa, mantenida por compatibilidad
        }

        function closeMonthModal() {
            document.getElementById('monthModal').classList.remove('active');
        }

        // HISTORIC VIEW
        function setHistoricView(mode) {
            historicViewMode = mode;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateHistoricView();
        }

        function updateHistoricView() {
            const startMonth = document.getElementById('historicStartMonth').value;
            const endMonth = document.getElementById('historicEndMonth').value;
            
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            // Update chart
            updateHistoricChart(filtered);

            if (historicViewMode === 'days') {
                updateHistoricTableDays(filtered);
            } else {
                updateHistoricTableMonths(filtered);
            }
        }

        function updateHistoricChart(data) {
            const ctx = document.getElementById('historicChart');
            
            let labels = [];
            let chartData = [];
            
            if (historicViewMode === 'days') {
                const sorted = [...data].sort((a, b) => a.fecha.localeCompare(b.fecha));
                labels = sorted.map(d => formatDate(d.fecha));
                chartData = sorted.map(d => roundTo5Cents(d.ingresos_dia || 0));
            } else {
                const monthlyData = {};
                data.forEach(d => {
                    const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                    if (!monthlyData[mesAnio]) {
                        monthlyData[mesAnio] = 0;
                    }
                    monthlyData[mesAnio] += d.ingresos_dia || 0;
                });
                
                const sorted = Object.keys(monthlyData).sort();
                labels = sorted.map(mesAnio => {
                    const [year, month] = mesAnio.split('-');
                    return `${monthNames[month]} ${year}`;
                });
                chartData = sorted.map(mesAnio => roundTo5Cents(monthlyData[mesAnio]));
            }

            if (historicChart) historicChart.destroy();

            historicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: chartData,
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateHistoricTableDays(data) {
            const sorted = [...data].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Ingressos</th>
                            <th>Serveis</th>
                            <th>‚Ç¨/Servei</th>
                            <th>Hores</th>
                            <th>‚Ç¨/Hora</th>
                            <th>Observacions</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                const revenueColor = getConditionalColor(row.ingresos_dia || 0, 150, 200);
                const hasObservations = row.observacions && row.observacions.trim() !== '';

                html += `
                    <tr>
                        <td>${formatDate(row.fecha)}</td>
                        <td>${diaSemana}</td>
                        <td>
                            <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(row.ingresos_dia || 0))}</span>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td>${row.servicios_dia || 0}</td>
                        <td>${formatCurrency(mediaPrecio)}</td>
                        <td>${row.horas_trabajadas ? row.horas_trabajadas.toFixed(1) : '-'}</td>
                        <td>${row.horas_trabajadas ? formatCurrency(mediaHora) : '-'}</td>
                        <td style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${row.observacions || ''}">${row.observacions || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${row.fecha}')">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('historicTableContainer').innerHTML = html;
        }

        function updateHistoricTableMonths(data) {
            const monthlyData = {};
            
            data.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (!monthlyData[mesAnio]) {
                    monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                monthlyData[mesAnio].dias += 1;
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Dies</th>
                            <th>Ingressos</th>
                            <th>Mitjana/dia</th>
                            <th>Serveis</th>
                            <th>‚Ç¨/Servei</th>
                            <th>Hores</th>
                            <th>‚Ç¨/Hora</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMonths.forEach(mesAnio => {
                const mData = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                const mediaDia = mData.dias > 0 ? mData.ingresos / mData.dias : 0;
                const mediaServicio = mData.servicios > 0 ? mData.ingresos / mData.servicios : 0;
                const mediaHora = mData.horas > 0 ? mData.ingresos / mData.horas : 0;
                
                const mediaDiaColor = getConditionalColor(mediaDia, 150, 200);
                const mediaHoraColor = getConditionalColor(mediaHora, 15, 23);

                html += `
                    <tr>
                        <td><strong>${monthName} ${year}</strong></td>
                        <td>${mData.dias}</td>
                        <td><strong>${formatCurrency(roundTo5Cents(mData.ingresos))}</strong></td>
                        <td style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</td>
                        <td>${mData.servicios}</td>
                        <td>${formatCurrency(roundTo5Cents(mediaServicio))}</td>
                        <td>${mData.horas > 0 ? mData.horas.toFixed(1) : '-'}</td>
                        <td style="color: ${mediaHoraColor}">${mData.horas > 0 ? formatCurrency(roundTo5Cents(mediaHora)) : '-'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('historicTableContainer').innerHTML = html;
        }

        // COMPARISON VIEW
        function updateComparisonView() {
            const startMonth = document.getElementById('comparisonStartMonth').value;
            const endMonth = document.getElementById('comparisonEndMonth').value;
            
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            const yearlyData = {};
            filtered.forEach(d => {
                const year = d.fecha.substring(0, 4);
                const month = d.fecha.substring(5, 7);
                
                if (!yearlyData[year]) yearlyData[year] = {};
                if (!yearlyData[year][month]) {
                    yearlyData[year][month] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                
                yearlyData[year][month].ingresos += d.ingresos_dia || 0;
                yearlyData[year][month].servicios += d.servicios_dia || 0;
                yearlyData[year][month].horas += d.horas_trabajadas || 0;
                yearlyData[year][month].dias += 1;
            });

            const years = Object.keys(yearlyData).sort();
            const months = [...new Set(filtered.map(d => d.fecha.substring(5, 7)))].sort();
            
            const labels = months.map(m => monthNames[m]);

            // Chart Ingresos
            updateComparisonChart('comparisonChartIngresos', 'Ingressos per mes', labels, years, yearlyData, 'ingresos');
            
            // Chart Media Diaria
            updateComparisonChart('comparisonChartMediaDia', 'Mitjana di√†ria per mes', labels, years, yearlyData, 'mediaDia');
            
            // Chart ‚Ç¨/Hora
            updateComparisonChart('comparisonChartHora', '‚Ç¨/Hora per mes', labels, years, yearlyData, 'hora');
        }

        function updateComparisonChart(canvasId, title, labels, years, yearlyData, metric) {
            const ctx = document.getElementById(canvasId);
            
            const colors = ['#ffc107', '#4caf50', '#2196f3', '#ff4444', '#9c27b0'];
            
            const datasets = years.map((year, index) => {
                const data = labels.map((label, idx) => {
                    const monthNum = Object.keys(monthNames).find(k => monthNames[k] === label);
                    const monthData = yearlyData[year][monthNum];
                    
                    if (!monthData) return 0;
                    
                    if (metric === 'ingresos') {
                        return roundTo5Cents(monthData.ingresos);
                    } else if (metric === 'mediaDia') {
                        return monthData.dias > 0 ? roundTo5Cents(monthData.ingresos / monthData.dias) : 0;
                    } else if (metric === 'hora') {
                        return monthData.horas > 0 ? roundTo5Cents(monthData.ingresos / monthData.horas) : 0;
                    }
                });
                
                return {
                    label: year,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            });

            let chart = null;
            if (canvasId === 'comparisonChartIngresos') chart = comparisonChartIngresos;
            else if (canvasId === 'comparisonChartMediaDia') chart = comparisonChartMediaDia;
            else if (canvasId === 'comparisonChartHora') chart = comparisonChartHora;
            
            if (chart) chart.destroy();

            const formatCallback = (value) => formatCurrency(value);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: ${formatCallback(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: formatCallback
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });

            if (canvasId === 'comparisonChartIngresos') {
                comparisonChartIngresos = chart;
            } else if (canvasId === 'comparisonChartMediaDia') {
                comparisonChartMediaDia = chart;
            } else if (canvasId === 'comparisonChartHora') {
                comparisonChartHora = chart;
            }
        }

        // ALL DAYS TABLE
        function updateAllDaysTable() {
            const sorted = [...allData].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Ingressos</th>
                            <th>Serveis</th>
                            <th>‚Ç¨/Servei</th>
                            <th>Hores</th>
                            <th>‚Ç¨/Hora</th>
                            <th>Observacions</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                const revenueColor = getConditionalColor(row.ingresos_dia || 0, 150, 200);
                const hasObservations = row.observacions && row.observacions.trim() !== '';

                html += `
                    <tr>
                        <td>${formatDate(row.fecha)}</td>
                        <td>${diaSemana}</td>
                        <td>
                            <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(row.ingresos_dia || 0))}</span>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td>${row.servicios_dia || 0}</td>
                        <td>${formatCurrency(mediaPrecio)}</td>
                        <td>${row.horas_trabajadas ? row.horas_trabajadas.toFixed(1) : '-'}</td>
                        <td>${row.horas_trabajadas ? formatCurrency(mediaHora) : '-'}</td>
                        <td style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${row.observacions || ''}">${row.observacions || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${row.fecha}')">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('allDaysTable').innerHTML = html;
        }

        // MODAL FUNCTIONS
        function openEditModal(fecha) {
            const data = allData.find(d => d.fecha === fecha);
            if (!data) return;

            currentEditDate = fecha;
            
            document.getElementById('fechaMonth').value = fecha;
            document.getElementById('ingresosMonth').value = data.ingresos_dia || '';
            document.getElementById('serviciosMonth').value = data.servicios_dia || '';
            document.getElementById('horasMonth').value = data.horas_trabajadas || '';
            document.getElementById('observacionsMonth').value = data.observacions || '';
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditDate = null;
        }

        // FORM FUNCTIONS
        function addNewDay(event, source) {
            event.preventDefault();
            
            const fechaId = source === 'month' ? 'fechaMonth' : 'fecha';
            const ingresosId = source === 'month' ? 'ingresosMonth' : 'ingresos';
            const serviciosId = source === 'month' ? 'serviciosMonth' : 'servicios';
            const horasId = source === 'month' ? 'horasMonth' : 'horas';
            const observacionsId = source === 'month' ? 'observacionsMonth' : 'observacions';
            
            const fecha = document.getElementById(fechaId).value;
            const ingresos = parseFloat(document.getElementById(ingresosId).value);
            const servicios = parseInt(document.getElementById(serviciosId).value);
            const horas = parseFloat(document.getElementById(horasId).value) || null;
            const observacions = document.getElementById(observacionsId).value.trim() || null;
            
            const newEntry = {
                mes_anio: fecha.substring(0, 7),
                fecha: fecha,
                dia_semana: null,
                semana_num: null,
                ingresos_dia: ingresos,
                servicios_dia: servicios,
                media_precio_servicio: servicios > 0 ? ingresos / servicios : null,
                horas_trabajadas: horas,
                media_ingresos_hora: horas ? ingresos / horas : null,
                observacions: observacions
            };
            
            try {
                const storedData = getStoredData();
                const storedIndex = storedData.findIndex(d => d.fecha === fecha);
                
                if (storedIndex >= 0) {
                    storedData[storedIndex] = newEntry;
                    showAlert('Dia actualitzat correctament', 'success', source);
                } else {
                    storedData.push(newEntry);
                    showAlert('Dia afegit correctament', 'success', source);
                }
                
                if (saveToStorage(storedData)) {
                    loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    resetForm(source);
                    if (source === 'month') {
                        closeModal();
                        closeMonthModal();
                    }
                } else {
                    showAlert('Error en desar', 'error', source);
                }
                
            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Error en desar el dia', 'error', source);
            }
        }

        function resetForm(source) {
            if (source === 'month') {
                document.getElementById('addDayFormMonth').reset();
                document.getElementById('fechaMonth').valueAsDate = new Date();
            } else {
                document.getElementById('addDayForm').reset();
                document.getElementById('fecha').valueAsDate = new Date();
            }
        }

        function showAlert(message, type, source) {
            const containerId = source === 'month' ? 'alertContainerMonth' : 'alertContainer';
            const container = document.getElementById(containerId);
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        function deleteDay(fecha) {
            if (!confirm(`Est√†s segur que vols eliminar el dia ${formatDate(fecha)}?`)) {
                return;
            }
            
            try {
                const storedData = getStoredData();
                const filteredStorage = storedData.filter(d => d.fecha !== fecha);
                
                if (saveToStorage(filteredStorage)) {
                    loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    closeModal();
                    closeMonthModal();
                    showAlert('Dia eliminat correctament', 'success', 'add');
                } else {
                    showAlert('Error en eliminar el dia', 'error', 'add');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                showAlert('Error en eliminar el dia', 'error', 'add');
            }
        }

        // EXPORT/IMPORT
        function exportJSON() {
            const storedData = getStoredData();
            const dataStr = JSON.stringify(storedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facturacio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('Format inv√†lid');
                    }
                    
                    if (saveToStorage(importedData)) {
                        loadData();
                        populateYearFilters();
                        updateDashboard();
                        updateMonthlyView();
                        updateHistoricView();
                        updateAllDaysTable();
                        alert(`Dades importades: ${importedData.length} registres`);
                    } else {
                        alert('Error en desar les dades');
                    }
                    
                } catch (error) {
                    console.error('Error importing:', error);
                    alert('Error en importar les dades');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function exportToCSV() {
            const startMonth = document.getElementById('historicStartMonth').value;
            const endMonth = document.getElementById('historicEndMonth').value;
            
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            const headers = ['Data', 'Dia', 'Ingressos', 'Serveis', '‚Ç¨/Servei', 'Hores', '‚Ç¨/Hora', 'Observacions'];
            const rows = filtered.map(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                
                return [
                    row.fecha,
                    diaSemana,
                    roundTo5Cents(row.ingresos_dia || 0),
                    row.servicios_dia || 0,
                    mediaPrecio.toFixed(2),
                    row.horas_trabajadas || '',
                    row.horas_trabajadas ? mediaHora.toFixed(2) : '',
                    row.observacions || ''
                ];
            });
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historic_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // INIT
        async function initApp() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/rogerboullosa/facturacion/refs/heads/main/taxi_data_updated.json');
                datosIniciales = await response.json();
            } catch (error) {
                console.error('Error loading initial data:', error);
                datosIniciales = [];
            }
            
            loadData();
            populateYearFilters();
            updateDashboard();
            updateMonthlyView();
            updateHistoricView();
            
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaMonth').valueAsDate = new Date();
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }, 500);
        }

        initApp();
    </script>
</body>
</html>
