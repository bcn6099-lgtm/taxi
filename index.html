<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Facturaci√≥ Taxi Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0e1a; --bg-secondary: #141827; --bg-card: #1a1f33;
            --accent-primary: #00d9ff; --accent-secondary: #7b61ff;
            --text-primary: #e8edf4; --text-secondary: #9ba3b4;
            --text-muted: #6b7280; --border: #2a3142;
            --success: #10b981; --error: #ef4444;
        }
        
        body { font-family: 'Archivo', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding-bottom: 50px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        h1 { font-size: 2rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .tabs-container { margin-bottom: 2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 0.5rem; display: flex; gap: 0.5rem; }
        .tab-button { flex: 1; padding: 0.875rem; border: none; background: transparent; color: var(--text-secondary); font-weight: 600; cursor: pointer; border-radius: 12px; }
        .tab-button.active { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: 0.3s; }
        .stat-card:hover { border-color: var(--accent-primary); transform: translateY(-3px); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; }
        .stat-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

        .section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; }
        .chart-box { height: 350px; width: 100%; margin: 1rem 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { text-align: left; padding: 12px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .day-col { color: var(--accent-primary); font-weight: 600; text-transform: capitalize; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-body { background: var(--bg-card); width: 90%; max-width: 900px; padding: 2rem; border-radius: 16px; position: relative; }
        
        .pagination { display: flex; justify-content: center; gap: 1rem; margin-top: 2rem; align-items: center; }
        .btn { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: white; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="modal" id="modal">
        <div class="modal-body">
            <h2 id="modalTitle">Tend√®ncia</h2>
            <div class="chart-box"><canvas id="modalChart"></canvas></div>
            <button class="btn" onclick="document.getElementById('modal').style.display='none'">Tancar</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üöñ Taxi Analytics</h1>
            <div>
                <button class="btn" onclick="exportData()">Desar JSON</button>
            </div>
        </header>

        <div class="tabs-container">
            <button class="tab-button active" onclick="showTab('month', event)">Mes Actual</button>
            <button class="tab-button" onclick="showTab('all', event)">Hist√≤ric</button>
            <button class="tab-button" onclick="showTab('comp', event)">Comparativa</button>
        </div>

        <div id="tab-month" class="tab-content active">
            <div class="stats-grid" id="mStats"></div>
            <div class="section">
                <h3>Detall del Mes</h3>
                <table>
                    <thead><tr><th>Data</th><th>Dia</th><th>Ingressos</th><th>Serveis</th><th>Hores</th><th>‚Ç¨/Hora</th></tr></thead>
                    <tbody id="mTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-all" class="tab-content">
            <div class="section">
                <h3>Evoluci√≥ Ingressos (√öltims 30 registros)</h3>
                <div class="chart-box"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="section">
                <table id="hTable">
                    <thead><tr><th>Data</th><th>Dia</th><th>Ingressos</th><th>Serveis</th><th>Hores</th><th>Accions</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="pag"></div>
            </div>
        </div>

        <div id="tab-comp" class="tab-content">
            <div class="section">
                <h3>Comparativa Temporal</h3>
                <div class="chart-box"><canvas id="compChart"></canvas></div>
                <div id="compText" style="margin-top:20px"></div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let curPage = 1;
        const perPage = 15;
        const dias = ['Diumenge', 'Dilluns', 'Dimarts', 'Dimecres', 'Dijous', 'Divendres', 'Dissabte'];

        async function init() {
            const local = localStorage.getItem('taxiData');
            if (local) {
                allData = JSON.parse(local);
            } else {
                try {
                    const res = await fetch('datos_taxi.json');
                    if (res.ok) allData = await res.json();
                } catch(e) {}
            }
            sort();
            render();
        }

        function sort() { allData.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)); }

        function showTab(id, e) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            e.target.classList.add('active');
            if(id === 'all') drawMain();
            if(id === 'comp') drawComp();
        }

        function render() {
            const now = new Date();
            const curMonth = now.toISOString().substring(0,7);
            const mData = allData.filter(d => d.fecha.startsWith(curMonth));
            const total = mData.reduce((a,b) => a+b.ingresos_dia, 0);

            // Stats
            document.getElementById('mStats').innerHTML = `
                <div class="stat-card" onclick="openMod('ing')"><div class="stat-label">Total Mes</div><div class="stat-value">${Math.round(total)}‚Ç¨</div></div>
                <div class="stat-card" onclick="openMod('hor')"><div class="stat-label">‚Ç¨ / Hora</div><div class="stat-value">${(total/(mData.reduce((a,b)=>a+(b.horas_trabajadas||0),0)||1)).toFixed(2)}‚Ç¨</div></div>
            `;

            // Table
            document.getElementById('mTable').innerHTML = mData.map(d => `
                <tr>
                    <td>${d.fecha}</td>
                    <td class="day-col">${dias[new Date(d.fecha).getDay()]}</td>
                    <td>${d.ingresos_dia.toFixed(2)}‚Ç¨</td>
                    <td>${d.servicios_dia}</td>
                    <td>${d.horas_trabajadas || 0}h</td>
                    <td>${d.horas_trabajadas ? (d.ingresos_dia/d.horas_trabajadas).toFixed(2) : 0}‚Ç¨</td>
                </tr>
            `).join('');

            renderHistory();
        }

        function renderHistory() {
            const start = (curPage-1)*perPage;
            const data = allData.slice(start, start+perPage);
            document.querySelector('#hTable tbody').innerHTML = data.map(d => `
                <tr>
                    <td>${d.fecha}</td>
                    <td class="day-col">${dias[new Date(d.fecha).getDay()]}</td>
                    <td>${d.ingresos_dia}‚Ç¨</td>
                    <td>${d.servicios_dia}</td>
                    <td>${d.horas_trabajadas}h</td>
                    <td><button class="btn" onclick="del('${d.fecha}')">üóëÔ∏è</button></td>
                </tr>
            `).join('');

            const totalP = Math.ceil(allData.length/perPage);
            document.getElementById('pag').innerHTML = `
                <button class="btn" onclick="curPage--;renderHistory()" ${curPage==1?'disabled':''}>Prev</button>
                <span>${curPage} / ${totalP}</span>
                <button class="btn" onclick="curPage++;renderHistory()" ${curPage==totalP?'disabled':''}>Seg</button>
            `;
        }

        function drawMain() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const d = [...allData].reverse().slice(-30);
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: d.map(x => x.fecha.split('-')[2]),
                    datasets: [{ label:'Ingressos', data: d.map(x=>x.ingresos_dia), backgroundColor:'#00d9ff' }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        function drawComp() {
            const ctx = document.getElementById('compChart').getContext('2d');
            // Agrupar por meses para el gr√°fico
            const months = {};
            allData.forEach(d => {
                const m = d.fecha.substring(0,7);
                months[m] = (months[m] || 0) + d.ingresos_dia;
            });
            const labels = Object.keys(months).sort().slice(-6);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label:'Evoluci√≥ Mensual', data: labels.map(l=>months[l]), borderColor:'#7b61ff', tension:0.4 }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        function openMod(type) {
            document.getElementById('modal').style.display = 'flex';
            const ctx = document.getElementById('modalChart').getContext('2d');
            const d = [...allData].reverse().slice(-15);
            const val = type === 'ing' ? d.map(x=>x.ingresos_dia) : d.map(x=>x.ingresos_dia/(x.horas_trabajadas||1));
            new Chart(ctx, {
                type: 'line',
                data: { labels: d.map(x=>x.fecha), datasets: [{ label: type, data: val, borderColor:'#00d9ff' }] },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        function del(f) { if(confirm('Borrar?')) { allData = allData.filter(x=>x.fecha!==f); localStorage.setItem('taxiData', JSON.stringify(allData)); render(); } }
        function exportData() {
            const b = new Blob([JSON.stringify(allData, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'datos_taxi.json'; a.click();
        }

        init();
    </script>
</body>
</html>
