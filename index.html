<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FacturaciÃ³ Taxi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #2a2a2a;
            --accent: #ffc107;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #404040;
            --color-green: #4caf50;
            --color-red: #ff4444;
            --color-yellow: #ffc107;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .menu-item {
            padding: 0.875rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }
        
        .menu-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .menu-item.active {
            background: var(--bg-card);
            color: var(--accent);
            border-left-color: var(--accent);
        }
        
        .menu-divider {
            height: 1px;
            background: var(--border);
            margin: 0.5rem 0;
        }
        
        .menu-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }
        
        .menu-toggle span {
            width: 20px;
            height: 2px;
            background: var(--bg-primary);
            transition: all 0.3s;
        }
        
        .menu-toggle.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .menu-toggle.active span:nth-child(2) {
            opacity: 0;
        }
        
        .menu-toggle.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        .main-content {
            margin-left: 0;
            padding: 1rem;
            padding-top: 4rem;
            min-height: 100vh;
        }
        
        @media (min-width: 768px) {
            .main-content {
                padding: 2rem;
                padding-top: 2rem;
            }
        }
        
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--accent);
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .stat-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .stat-change {
            font-size: 0.75rem;
            margin-top: 2px;
        }
        
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .section-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--accent);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .form-input, .form-textarea, select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-input:focus, .form-textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #e6b000;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-card);
        }
        
        .btn-danger {
            background: var(--color-red);
            color: white;
        }
        
        .btn-danger:hover {
            background: #cc0000;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg-secondary);
        }
        
        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        tbody tr:hover {
            background: rgba(255, 193, 7, 0.05);
        }
        
        .action-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .modal-close, .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        
        .modal-close:hover, .close-btn:hover {
            color: var(--text-primary);
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .alert-success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--color-green);
            color: var(--color-green);
        }
        
        .alert-error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--color-red);
            color: var(--color-red);
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .calendar-day-header {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            font-weight: 600;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .calendar-day:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }
        
        .calendar-day.has-data {
            background: rgba(255, 193, 7, 0.1);
        }
        
        .calendar-day-number {
            font-size: 0.75rem;
            font-weight: 600;
            position: absolute;
            top: 0.25rem;
            left: 0.5rem;
        }
        
        .calendar-day-amount {
            font-size: 1.1rem;
            color: var(--accent);
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
        }
        
        .calendar-month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .calendar-month-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .calendar-nav-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .calendar-nav-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent);
        }
        
        .filters {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .filters select {
            flex: 1;
            min-width: 200px;
        }
        
        .view-selector {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .view-btn {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .view-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        
        .range-slider-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .range-slider-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: block;
        }
        
        .range-slider-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .range-input {
            flex: 1;
            min-width: 150px;
        }
        
        .range-input label {
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            display: block;
            color: var(--text-secondary);
        }
        
        .observation-alert {
            color: var(--accent);
            font-weight: 700;
            margin-left: 0.25rem;
            font-size: 1.2rem;
            vertical-align: middle;
        }
        
        .revenue-amount {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .weekday-abbr {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-grid {
                gap: 0.25rem;
            }
            
            .calendar-day {
                padding: 0.25rem;
            }
            
            .calendar-day-number {
                font-size: 0.6rem;
                top: 0.15rem;
                left: 0.3rem;
            }
            
            .calendar-day-amount {
                font-size: 0.85rem;
            }
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .month-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .total-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .total-item {
            text-align: center;
        }

        .total-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .total-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            margin-top: 0.25rem;
        }

        /* MONTH CARDS */
        .month-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .month-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-card-left {
            flex: 1;
        }

        .month-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .month-card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .month-card-revenue {
            font-size: 2rem;
            font-weight: 700;
            text-align: right;
        }

        .month-card-comparisons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        /* MONTH DETAIL MODAL */
        .month-detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .month-detail-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .month-detail-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .month-detail-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .month-detail-observations {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .month-detail-observations h4 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .month-detail-observations ul {
            list-style: none;
            padding: 0;
        }

        .month-detail-observations li {
            padding: 0.5rem 0;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .month-detail-days-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
        }

        .month-detail-day {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-detail-day:hover {
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .month-detail-day-date {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .month-detail-day-revenue {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .month-detail-day-icon {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading">
        <div class="loading-spinner"></div>
        <span>Carregant dades...</span>
    </div>

    <button class="menu-toggle" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">ðŸ“Š Taxi Control</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="navigateTo('dashboard')">ðŸ“ˆ Resum</div>
            <div class="menu-item" onclick="navigateTo('dies')">ðŸ“… Dies</div>
            <div class="menu-item" onclick="navigateTo('mesos')">ðŸ“† Mesos</div>
            <div class="menu-item" onclick="navigateTo('historic')">ðŸ“‹ HistÃ²ric</div>
            <div class="menu-item" onclick="navigateTo('comparison')">ðŸ”„ Comparativa</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="navigateTo('add')">âž• Afegir dia</div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="exportJSON()">ðŸ’¾ Exportar JSON</div>
            <div class="menu-item" onclick="document.getElementById('importFile').click()">ðŸ“‚ Importar JSON</div>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
        </div>
    </div>

    <div id="mainContent" style="display:none">
        <div class="main-content">
            
            <!-- DASHBOARD PAGE -->
            <div id="dashboard" class="page active">
                <h1 class="page-title">ðŸ“ˆ Resum General</h1>
                
                <div class="filters">
                    <label for="monthFilter">Selecciona mes:</label>
                    <select id="monthFilter" onchange="updateDashboard()">
                        <option value="all">Tots els mesos</option>
                    </select>
                    <label for="projectionDays" style="margin-left: 2rem;">Dies per a la projecciÃ³:</label>
                    <select id="projectionDays" onchange="updateDashboard()" style="width: auto; min-width: 80px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21" selected>21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                    </select>
                </div>

                <div id="statsGrid" class="stats-grid"></div>

                <div class="total-summary">
                    <div class="total-item">
                        <div class="total-label">Total Ingressos</div>
                        <div class="total-value" id="totalIngresosSum">0â‚¬</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">Total Serveis</div>
                        <div class="total-value" id="totalServiciosSum">0</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-header">
                        <h2 class="chart-title">EvoluciÃ³ DiÃ ria</h2>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- DIES VIEW PAGE -->
            <div id="dies" class="page">
                <h1 class="page-title">ðŸ“… Vista per Dies</h1>
                
                <div class="filters">
                    <label for="yearFilterDies">Any:</label>
                    <select id="yearFilterDies" onchange="updateDiesView()">
                        <option value="all">Tots els anys</option>
                    </select>
                </div>
                
                <div class="section-container">
                    <div class="calendar-month-nav">
                        <button class="calendar-nav-btn" id="prevMonth">â—€</button>
                        <h2 class="calendar-month-title" id="currentMonthTitle"></h2>
                        <button class="calendar-nav-btn" id="nextMonth">â–¶</button>
                    </div>
                    
                    <div class="stats-grid" id="diesStats"></div>
                    
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <!-- MESOS VIEW PAGE -->
            <div id="mesos" class="page">
                <h1 class="page-title">ðŸ“† Vista per Mesos</h1>
                
                <div class="filters">
                    <label for="yearFilterMesos">Any:</label>
                    <select id="yearFilterMesos" onchange="updateMesosView()">
                        <option value="all">Tots els anys</option>
                    </select>
                </div>

                <div id="mesosContainer"></div>
            </div>

            <!-- HISTORIC PAGE -->
            <div id="historic" class="page">
                <h1 class="page-title">ðŸ“‹ HistÃ²ric</h1>
                
                <div class="view-selector">
                    <button class="view-btn active" onclick="setHistoricViewMode('days')">Per dies</button>
                    <button class="view-btn" onclick="setHistoricViewMode('months')">Per mesos</button>
                </div>

                <div class="range-slider-container">
                    <span class="range-slider-label">Selecciona el rang de dates:</span>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="historicStartMonth"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="historicEndMonth"></select>
                        </div>
                        <button class="btn btn-primary" onclick="updateHistoricView()">Actualitzar</button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="historicChart" height="80"></canvas>
                </div>
                
                <div class="table-container" id="historicTableContainer"></div>
            </div>

            <!-- COMPARISON PAGE -->
            <div id="comparison" class="page">
                <h1 class="page-title">ðŸ”„ Comparativa per Anys</h1>
                
                <div class="range-slider-container">
                    <span class="range-slider-label">Selecciona el rang de mesos a comparar:</span>
                    <div class="range-slider-inputs">
                        <div class="range-input">
                            <label>Des de:</label>
                            <select id="comparisonStartMonth"></select>
                        </div>
                        <div class="range-input">
                            <label>Fins a:</label>
                            <select id="comparisonEndMonth"></select>
                        </div>
                        <button class="btn btn-primary" onclick="updateComparisonView()">Actualitzar</button>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Ingressos per mes</h3>
                    <canvas id="comparisonChartIngresos"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Mitjana diÃ ria per mes</h3>
                    <canvas id="comparisonChartMediaDia"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">â‚¬/Hora per mes</h3>
                    <canvas id="comparisonChartHora"></canvas>
                </div>
            </div>

            <!-- ADD DAY PAGE -->
            <div id="add" class="page">
                <h1 class="page-title">âž• Afegir Dia</h1>
                
                <div id="alertContainer"></div>
                
                <div class="section-container">
                    <form id="addDayForm" onsubmit="addNewDay(event, 'add'); return false;">
                        <div class="form-group">
                            <label class="form-label" for="fecha">Data</label>
                            <input type="date" id="fecha" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="ingresos">Ingressos del Dia (â‚¬)</label>
                            <input type="number" id="ingresos" class="form-input" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="servicios">Nombre de Serveis</label>
                            <input type="number" id="servicios" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="horas">Hores Treballades</label>
                            <input type="number" id="horas" class="form-input" step="0.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="observacions">Observacions</label>
                            <textarea id="observacions" class="form-textarea"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Afegir Dia</button>
                    </form>
                </div>

                <div class="section-container">
                    <h2 class="section-title">Tots els Dies</h2>
                    <div class="table-container" id="allDaysTableContainer"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Dia</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            
            <div id="alertContainerMonth"></div>
            
            <form id="addDayFormMonth" onsubmit="addNewDay(event, 'month'); return false;">
                <div class="form-group">
                    <label class="form-label" for="fechaMonth">Data</label>
                    <input type="date" id="fechaMonth" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="ingresosMonth">Ingressos del Dia (â‚¬)</label>
                    <input type="number" id="ingresosMonth" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="serviciosMonth">Nombre de Serveis</label>
                    <input type="number" id="serviciosMonth" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="horasMonth">Hores Treballades</label>
                    <input type="number" id="horasMonth" class="form-input" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label" for="observacionsMonth">Observacions</label>
                    <textarea id="observacionsMonth" class="form-textarea"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="deleteDay(currentEditDate)">Eliminar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">CancelÂ·lar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MONTH MODAL -->
    <div class="modal" id="monthModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Afegir Nou Dia</h2>
                <button class="modal-close" onclick="closeMonthModal()">Ã—</button>
            </div>
            
            <div id="alertContainerMonthAdd"></div>
            
            <form id="addDayFormMonthModal" onsubmit="addNewDay(event, 'monthAdd'); return false;">
                <div class="form-group">
                    <label class="form-label" for="fechaMonthAdd">Data</label>
                    <input type="date" id="fechaMonthAdd" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="ingresosMonthAdd">Ingressos del Dia (â‚¬)</label>
                    <input type="number" id="ingresosMonthAdd" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="serviciosMonthAdd">Nombre de Serveis</label>
                    <input type="number" id="serviciosMonthAdd" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="horasMonthAdd">Hores Treballades</label>
                    <input type="number" id="horasMonthAdd" class="form-input" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label" for="observacionsMonthAdd">Observacions</label>
                    <textarea id="observacionsMonthAdd" class="form-textarea"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Afegir</button>
                    <button type="button" class="btn btn-secondary" onclick="closeMonthModal()">CancelÂ·lar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MONTH DETAIL MODAL -->
    <div class="modal" id="monthDetailModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="monthDetailTitle">Detall del Mes</h2>
                <button class="modal-close" onclick="closeMonthDetailModal()">Ã—</button>
            </div>
            
            <div id="monthDetailContent"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // INDEXEDDB CONFIGURATION
        // ==========================================
        const DB_NAME = 'TaxiFacturacioDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'facturacio_data';
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Error opening database:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'fecha' });
                        objectStore.createIndex('mes_anio', 'mes_anio', { unique: false });
                        console.log('Object store created');
                    }
                };
            });
        }

        async function saveToStorage(data) {
            if (!db) {
                console.error('Database not initialized');
                return false;
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                
                await objectStore.clear();
                
                for (const record of data) {
                    await objectStore.add(record);
                }
                
                return new Promise((resolve, reject) => {
                    transaction.oncomplete = () => {
                        console.log('Data saved successfully');
                        resolve(true);
                    };
                    transaction.onerror = () => {
                        console.error('Error saving data:', transaction.error);
                        reject(false);
                    };
                });
            } catch (error) {
                console.error('Error in saveToStorage:', error);
                return false;
            }
        }

        async function getStoredData() {
            if (!db) {
                console.error('Database not initialized');
                return [];
            }
            
            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        resolve(request.result || []);
                    };
                    request.onerror = () => {
                        console.error('Error getting data:', request.error);
                        resolve([]);
                    };
                });
            } catch (error) {
                console.error('Error in getStoredData:', error);
                return [];
            }
        }

        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let allData = [];
        let filteredData = [];
        let datosIniciales = [];
        let currentEditDate = null;
        let currentMonthView = new Date();
        let revenueChart = null;
        let historicChart = null;
        let historicViewMode = 'days';
        const comparisonCharts = {};

        const diasSemana = {
            'Monday': 'dl',
            'Tuesday': 'dm',
            'Wednesday': 'dc',
            'Thursday': 'dj',
            'Friday': 'dv',
            'Saturday': 'ds',
            'Sunday': 'du'
        };

        const monthNames = {
            '01': 'Gener', '02': 'Febrer', '03': 'MarÃ§', '04': 'Abril',
            '05': 'Maig', '06': 'Juny', '07': 'Juliol', '08': 'Agost',
            '09': 'Setembre', '10': 'Octubre', '11': 'Novembre', '12': 'Desembre'
        };

        // ==========================================
        // HELPER FUNCTIONS
        // ==========================================
        function roundTo5Cents(value) {
            return Math.round(value * 20) / 20;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('ca-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(value) {
            if (value >= 1000) {
                return Math.round(value) + 'â‚¬';
            }
            return value.toFixed(2) + 'â‚¬';
        }

        function calculateChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous * 100);
        }

        function getConditionalColor(value, min, max) {
            if (value <= min) return 'var(--color-red)';
            if (value >= max) return 'var(--color-green)';
            const ratio = (value - min) / (max - min);
            if (ratio < 0.5) {
                return `rgb(255, ${Math.round(193 * ratio * 2)}, 68)`;
            } else {
                return `rgb(${Math.round(255 - 179 * (ratio - 0.5) * 2)}, ${Math.round(193 + 82 * (ratio - 0.5) * 2)}, ${Math.round(7 + 73 * (ratio - 0.5) * 2)})`;
            }
        }

        function getMonthlyRevenueColor(value) {
            return getConditionalColor(value, 2500, 6700);
        }

        function getPositiveColor(percentage) {
            return 'var(--color-green)';
        }

        function getNegativeColor(percentage) {
            return 'var(--color-red)';
        }

        // ==========================================
        // DATA MANAGEMENT
        // ==========================================
        async function loadData() {
            try {
                const storedData = await getStoredData();
                
                if (storedData.length === 0 && datosIniciales.length > 0) {
                    allData = datosIniciales;
                    await saveToStorage(allData);
                } else {
                    allData = storedData;
                }
                
                filteredData = [...allData];
                console.log('Data loaded:', allData.length, 'records');
            } catch (error) {
                console.error('Error loading data:', error);
                allData = datosIniciales;
                filteredData = [...allData];
            }
        }

        function populateYearFilters() {
            const years = [...new Set(allData.map(d => d.fecha.substring(0, 4)))].sort().reverse();
            
            // Filter para Dies
            const yearFilterDies = document.getElementById('yearFilterDies');
            yearFilterDies.innerHTML = '<option value="all">Tots els anys</option>';
            years.forEach(year => {
                yearFilterDies.innerHTML += `<option value="${year}">${year}</option>`;
            });

            // Filter para Mesos
            const yearFilterMesos = document.getElementById('yearFilterMesos');
            yearFilterMesos.innerHTML = '<option value="all">Tots els anys</option>';
            years.forEach(year => {
                yearFilterMesos.innerHTML += `<option value="${year}">${year}</option>`;
            });

            const monthFilter = document.getElementById('monthFilter');
            const allMonths = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort().reverse();
            monthFilter.innerHTML = '<option value="all">Tots els mesos</option>';
            allMonths.forEach(mesAnio => {
                const [year, monthNum] = mesAnio.split('-');
                const monthName = monthNames[monthNum];
                monthFilter.innerHTML += `<option value="${mesAnio}">${monthName} ${year}</option>`;
            });
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (allMonths.includes(currentMonth)) {
                monthFilter.value = currentMonth;
            }

            populateMonthRangeSelectors('historic');
            populateMonthRangeSelectors('comparison');
        }

        function populateMonthRangeSelectors(view) {
            const months = [...new Set(allData.map(d => d.mes_anio || d.fecha.substring(0, 7)))].sort();
            const startSelect = document.getElementById(view === 'historic' ? 'historicStartMonth' : 'comparisonStartMonth');
            const endSelect = document.getElementById(view === 'historic' ? 'historicEndMonth' : 'comparisonEndMonth');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            months.forEach((month, index) => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[monthNum];
                const label = `${monthName} ${year}`;
                startSelect.innerHTML += `<option value="${month}" ${index === 0 ? 'selected' : ''}>${label}</option>`;
                endSelect.innerHTML += `<option value="${month}" ${index === months.length - 1 ? 'selected' : ''}>${label}</option>`;
            });
        }

        // ==========================================
        // NAVIGATION
        // ==========================================
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.menu-toggle');
            sidebar.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            event.target.classList.add('active');
            
            toggleMenu();

            if (page === 'dies') updateDiesView();
            if (page === 'mesos') updateMesosView();
            if (page === 'historic') updateHistoricView();
            if (page === 'comparison') updateComparisonView();
            if (page === 'add') updateAllDaysTable();
        }

        // ==========================================
        // DASHBOARD
        // ==========================================
        function updateDashboard() {
            const monthFilter = document.getElementById('monthFilter').value;
            const projectionDays = parseInt(document.getElementById('projectionDays').value);
            let targetMonth = monthFilter;
            if (monthFilter === 'all') {
                const now = new Date();
                targetMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            const getStats = (monthStr) => {
                const data = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === monthStr);
                const ingresos = data.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
                const servicios = data.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
                const horas = data.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
                const dias = data.length;
                return {
                    ingresos, servicios, horas, dias,
                    mediaDia: dias > 0 ? ingresos / dias : 0,
                    mediaServ: servicios > 0 ? ingresos / servicios : 0,
                    mediaHora: horas > 0 ? ingresos / horas : 0
                };
            };

            const currentStats = getStats(targetMonth);
            const proyeccion = currentStats.mediaDia * projectionDays;

            const [currentYearStr, currentMonthStr] = targetMonth.split('-');
            const currentYear = parseInt(currentYearStr);
            const currentMonthNum = parseInt(currentMonthStr);

            const prevYearMonth = `${currentYear - 1}-${currentMonthStr}`;
            let prevMonthDate = new Date(currentYear, currentMonthNum - 1 - 1, 1);
            const prevMonthStr = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;
            const year2019Month = `2019-${currentMonthStr}`;

            const prevYearStats = getStats(prevYearMonth);
            const prevMonthStats = getStats(prevMonthStr);
            const year2019Stats = getStats(year2019Month);

            const generateComparisonHTML = (currentVal, prevYearVal, prevMonthVal, year2019Val) => {
                const changePrevYear = calculateChange(currentVal, prevYearVal);
                const changePrevMonth = calculateChange(currentVal, prevMonthVal);
                const change2019 = calculateChange(currentVal, year2019Val);
                
                const formatChange = (val, label) => {
                    const color = val >= 0 ? getPositiveColor(val) : getNegativeColor(val);
                    const arrow = val >= 0 ? 'â–²' : 'â–¼';
                    return `
                        <div class="stat-change" style="color: ${color}; font-weight: 600;">
                            ${arrow} ${Math.abs(val).toFixed(1)}% <small>(${label})</small>
                        </div>
                    `;
                };

                let html = '';
                if (prevYearVal > 0) html += formatChange(changePrevYear, 'Any anterior');
                if (prevMonthVal > 0) html += formatChange(changePrevMonth, 'Mes anterior');
                if (year2019Val > 0) html += formatChange(change2019, '2019');
                return html;
            };

            const mediaDiaColor = getConditionalColor(currentStats.mediaDia, 150, 320);
            const mediaHoraColor = getConditionalColor(currentStats.mediaHora, 15, 25);
            const proyeccionColor = getMonthlyRevenueColor(proyeccion);

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Ingressos del mes</div>
                    <div class="stat-value">${formatCurrency(roundTo5Cents(currentStats.ingresos))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ProjecciÃ³ (${projectionDays} dies)</div>
                    <div class="stat-value" style="color: ${proyeccionColor}">${formatCurrency(roundTo5Cents(proyeccion))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per hora</div>
                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(roundTo5Cents(currentStats.mediaHora))}</div>
                    ${generateComparisonHTML(currentStats.mediaHora, prevYearStats.mediaHora, prevMonthStats.mediaHora, year2019Stats.mediaHora)}
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mitjana per dia</div>
                    <div class="stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(currentStats.mediaDia))}</div>
                    ${generateComparisonHTML(currentStats.mediaDia, prevYearStats.mediaDia, prevMonthStats.mediaDia, year2019Stats.mediaDia)}
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHtml;
            
            filteredData = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === targetMonth);
            
            const allTotalIngresos = allData.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
            const allTotalServicios = allData.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
            
            document.getElementById('totalIngresosSum').textContent = formatCurrency(roundTo5Cents(allTotalIngresos));
            document.getElementById('totalServiciosSum').textContent = allTotalServicios;

            updateRevenueChart();
        }

        function updateRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            const sortedData = [...filteredData].sort((a, b) => a.fecha.localeCompare(b.fecha));
            const labels = sortedData.map(d => formatDate(d.fecha));
            const data = sortedData.map(d => roundTo5Cents(d.ingresos_dia || 0));

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: data,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // DIES VIEW
        // ==========================================
        function updateDiesView() {
            const yearFilter = document.getElementById('yearFilterDies').value;
            const year = currentMonthView.getFullYear();
            const month = currentMonthView.getMonth();
            
            document.getElementById('currentMonthTitle').textContent = 
                currentMonthView.toLocaleDateString('ca-ES', { month: 'long', year: 'numeric' });
            
            const monthStr = `${year}-${(month + 1).toString().padStart(2, '0')}`;
            let monthData = allData.filter(d => d.fecha.startsWith(monthStr));
            
            if (yearFilter !== 'all') {
                monthData = monthData.filter(d => d.fecha.startsWith(yearFilter));
            }
            
            const stats = calculateStats(monthData);
            const mediaHoraColor = getConditionalColor(stats.mediaHora, 15, 25);
            
            document.getElementById('diesStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total</div>
                    <div class="stat-value">${formatCurrency(stats.ingresos)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Serveis</div>
                    <div class="stat-value">${stats.servicios}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">â‚¬/Servei</div>
                    <div class="stat-value">${formatCurrency(stats.mediaServicio)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">â‚¬/Hora</div>
                    <div class="stat-value" style="color: ${mediaHoraColor}">${formatCurrency(stats.mediaHora)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dies treballats</div>
                    <div class="stat-value">${monthData.length}</div>
                </div>
            `;
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            ['Dl', 'Dt', 'Dc', 'Dj', 'Dv', 'Ds', 'Dg'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay() || 7;
            
            for (let i = 1; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                calendarGrid.appendChild(emptyCell);
            }
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${monthStr}-${day.toString().padStart(2, '0')}`;
                const dayData = monthData.find(d => d.fecha === dateStr);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                if (dayData) {
                    dayCell.classList.add('has-data');
                    dayCell.onclick = () => openEditModal(dateStr);
                    
                    const revenueColor = getConditionalColor(dayData.ingresos_dia || 0, 150, 300);
                    const hasObservations = dayData.observacions && dayData.observacions.trim() !== '';
                    
                    dayCell.innerHTML = `
                        <div class="calendar-day-number">${day}</div>
                        <div class="calendar-day-amount" style="color: ${revenueColor}">
                            ${formatCurrency(dayData.ingresos_dia)}
                            ${hasObservations ? ' <span class="observation-alert">*</span>' : ''}
                        </div>
                    `;
                } else {
                    dayCell.onclick = () => openAddModalForDate(dateStr);
                    dayCell.innerHTML = `<div class="calendar-day-number">${day}</div>`;
                }
                
                calendarGrid.appendChild(dayCell);
            }
        }

        // ==========================================
        // MESOS VIEW
        // ==========================================
        function updateMesosView() {
            const yearFilter = document.getElementById('yearFilterMesos').value;
            
            let filteredData = allData;
            if (yearFilter !== 'all') {
                filteredData = allData.filter(d => d.fecha.startsWith(yearFilter));
            }
            
            // Agrupar por mes
            const monthlyData = {};
            const monthsWithObservations = new Set();
            
            filteredData.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (!monthlyData[mesAnio]) {
                    monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                monthlyData[mesAnio].dias += 1;
                
                if (d.observacions && d.observacions.trim() !== '') {
                    monthsWithObservations.add(mesAnio);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = '';

            sortedMonths.forEach(mesAnio => {
                const mData = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                const hasObservations = monthsWithObservations.has(mesAnio);
                const revenueColor = getMonthlyRevenueColor(mData.ingresos);

                // Calcular comparativas
                const prevYearMesAnio = `${parseInt(year) - 1}-${month}`;
                const prevYearData = monthlyData[prevYearMesAnio];
                
                const year2019MesAnio = `2019-${month}`;
                const year2019Data = monthlyData[year2019MesAnio];
                
                let prevYearChange = '';
                let prevYearLabel = '';
                let year2019Label = '';
                
                if (prevYearData) {
                    const change = calculateChange(mData.ingresos, prevYearData.ingresos);
                    const arrow = change >= 0 ? 'â–²' : 'â–¼';
                    const color = change >= 0 ? 'var(--color-green)' : 'var(--color-red)';
                    prevYearChange = `<span style="color: ${color}">${arrow}${Math.abs(change).toFixed(1)}% (Any anterior)</span>`;
                    prevYearLabel = `<span style="color: ${color}">${arrow}${Math.abs(change).toFixed(1)}% (${parseInt(year) - 1})</span>`;
                }
                
                if (year2019Data && year !== '2019') {
                    const change = calculateChange(mData.ingresos, year2019Data.ingresos);
                    const arrow = change >= 0 ? 'â–²' : 'â–¼';
                    const color = change >= 0 ? 'var(--color-green)' : 'var(--color-red)';
                    year2019Label = `<span style="color: ${color}">${arrow}${Math.abs(change).toFixed(1)}% (2019)</span>`;
                }

                html += `
                    <div class="month-card" onclick="openMonthDetail('${mesAnio}')">
                        <div class="month-card-header">
                            <div class="month-card-left">
                                <div class="month-card-title">
                                    ${monthName} ${year}
                                    ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                                </div>
                                <div class="month-card-subtitle">${mData.dias} dies Â· ${mData.servicios} serveis</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="month-card-revenue" style="color: ${revenueColor}">
                                    ${formatCurrency(roundTo5Cents(mData.ingresos))}
                                </div>
                                <div class="month-card-comparisons">
                                    ${prevYearLabel ? prevYearLabel : ''}
                                    ${year2019Label ? year2019Label : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('mesosContainer').innerHTML = html;
        }

        // ==========================================
        // MONTH DETAIL MODAL
        // ==========================================
        function openMonthDetail(mesAnio) {
            const [year, month] = mesAnio.split('-');
            const monthName = monthNames[month];
            
            document.getElementById('monthDetailTitle').textContent = `${monthName} ${year}`;
            
            // Filtrar datos del mes
            const monthData = allData.filter(d => (d.mes_anio || d.fecha.substring(0, 7)) === mesAnio);
            
            // Calcular estadÃ­sticas
            const stats = calculateStats(monthData);
            const mediaDiaColor = getConditionalColor(stats.ingresos / monthData.length, 150, 320);
            const mediaHoraColor = getConditionalColor(stats.mediaHora, 15, 25);
            
            // Obtener observaciones
            const observaciones = monthData
                .filter(d => d.observacions && d.observacions.trim() !== '')
                .map(d => ({
                    fecha: d.fecha,
                    observacio: d.observacions
                }));
            
            let observacionesHTML = '';
            if (observaciones.length > 0) {
                observacionesHTML = `
                    <div class="month-detail-observations">
                        <h4>Observacions:</h4>
                        <ul>
                            ${observaciones.map(obs => `
                                <li><strong>${formatDate(obs.fecha)}:</strong> ${obs.observacio}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Ordenar dÃ­as
            const sortedDays = [...monthData].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            const contentHTML = `
                <div class="month-detail-stats">
                    <div class="month-detail-stat-card">
                        <div class="month-detail-stat-label">TOTAL</div>
                        <div class="month-detail-stat-value">${formatCurrency(stats.ingresos)}</div>
                    </div>
                    <div class="month-detail-stat-card">
                        <div class="month-detail-stat-label">MITJANA/DIA</div>
                        <div class="month-detail-stat-value" style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(stats.ingresos / monthData.length))}</div>
                    </div>
                    <div class="month-detail-stat-card">
                        <div class="month-detail-stat-label">SERVEIS</div>
                        <div class="month-detail-stat-value">${stats.servicios}</div>
                    </div>
                    <div class="month-detail-stat-card">
                        <div class="month-detail-stat-label">â‚¬/SERVEI</div>
                        <div class="month-detail-stat-value">${formatCurrency(stats.mediaServicio)}</div>
                    </div>
                    <div class="month-detail-stat-card">
                        <div class="month-detail-stat-label">â‚¬/HORA</div>
                        <div class="month-detail-stat-value" style="color: ${mediaHoraColor}">${formatCurrency(stats.mediaHora)}</div>
                    </div>
                </div>
                
                ${observacionesHTML}
                
                <div class="month-detail-days-title">Dies:</div>
                ${sortedDays.map(day => {
                    const fecha = new Date(day.fecha + 'T12:00:00');
                    const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                    const revenueColor = getConditionalColor(day.ingresos_dia || 0, 150, 300);
                    const hasObservations = day.observacions && day.observacions.trim() !== '';
                    
                    return `
                        <div class="month-detail-day" onclick="openEditModal('${day.fecha}'); closeMonthDetailModal();">
                            <div class="month-detail-day-date">${formatDate(day.fecha)} - ${diaSemana.toUpperCase()}</div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="month-detail-day-revenue" style="color: ${revenueColor}">
                                    ${formatCurrency(roundTo5Cents(day.ingresos_dia))}${hasObservations ? ' <span class="observation-alert">*</span>' : ''}
                                </div>
                                <div class="month-detail-day-icon">âœï¸</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
            
            document.getElementById('monthDetailContent').innerHTML = contentHTML;
            document.getElementById('monthDetailModal').classList.add('active');
        }

        function closeMonthDetailModal() {
            document.getElementById('monthDetailModal').classList.remove('active');
        }

        function calculateStats(data) {
            const ingresos = data.reduce((sum, d) => sum + (d.ingresos_dia || 0), 0);
            const servicios = data.reduce((sum, d) => sum + (d.servicios_dia || 0), 0);
            const horas = data.reduce((sum, d) => sum + (d.horas_trabajadas || 0), 0);
            
            return {
                ingresos: roundTo5Cents(ingresos),
                servicios: servicios,
                horas: horas,
                mediaServicio: servicios > 0 ? roundTo5Cents(ingresos / servicios) : 0,
                mediaHora: horas > 0 ? roundTo5Cents(ingresos / horas) : 0
            };
        }

        // ==========================================
        // HISTORIC VIEW
        // ==========================================
        function setHistoricViewMode(mode) {
            historicViewMode = mode;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateHistoricView();
        }

        function updateHistoricView() {
            const startMonth = document.getElementById('historicStartMonth').value;
            const endMonth = document.getElementById('historicEndMonth').value;
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            updateHistoricChart(filtered);

            if (historicViewMode === 'days') {
                updateHistoricTableDays(filtered);
            } else {
                updateHistoricTableMonths(filtered);
            }
        }

        function updateHistoricChart(data) {
            const ctx = document.getElementById('historicChart');
            let labels = [];
            let chartData = [];
            
            if (historicViewMode === 'days') {
                const sorted = [...data].sort((a, b) => a.fecha.localeCompare(b.fecha));
                labels = sorted.map(d => formatDate(d.fecha));
                chartData = sorted.map(d => roundTo5Cents(d.ingresos_dia || 0));
            } else {
                const monthlyData = {};
                data.forEach(d => {
                    const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                    if (!monthlyData[mesAnio]) {
                        monthlyData[mesAnio] = 0;
                    }
                    monthlyData[mesAnio] += d.ingresos_dia || 0;
                });
                const sorted = Object.keys(monthlyData).sort();
                labels = sorted.map(mesAnio => {
                    const [year, month] = mesAnio.split('-');
                    return `${monthNames[month]} ${year}`;
                });
                chartData = sorted.map(mesAnio => roundTo5Cents(monthlyData[mesAnio]));
            }

            if (historicChart) historicChart.destroy();
            historicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingressos',
                        data: chartData,
                        backgroundColor: '#ffc107'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#b0b0b0',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateHistoricTableDays(data) {
            const sorted = [...data].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Dia</th>
                            <th>Ingressos</th>
                            <th>Observacions</th>
                            <th>â‚¬/Hora</th>
                            <th>Serveis</th>
                            <th>â‚¬/Servei</th>
                            <th>Hores</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sorted.forEach(row => {
                const fecha = new Date(row.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = row.servicios_dia ? roundTo5Cents(row.ingresos_dia / row.servicios_dia) : 0;
                const mediaHora = row.horas_trabajadas ? roundTo5Cents(row.ingresos_dia / row.horas_trabajadas) : 0;
                const revenueColor = getConditionalColor(row.ingresos_dia || 0, 150, 300);
                const hasObservations = row.observacions && row.observacions.trim() !== '';

                html += `
                    <tr>
                        <td>${formatDate(row.fecha)}</td>
                        <td class="weekday-abbr">${diaSemana}</td>
                        <td>
                            <span class="revenue-amount" style="color: ${revenueColor}">${formatCurrency(roundTo5Cents(row.ingresos_dia || 0))}</span>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td style="font-size: 0.75rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${row.observacions || ''}">${row.observacions || '-'}</td>
                        <td>${row.horas_trabajadas ? formatCurrency(mediaHora) : '-'}</td>
                        <td>${row.servicios_dia || 0}</td>
                        <td>${formatCurrency(mediaPrecio)}</td>
                        <td>${row.horas_trabajadas ? row.horas_trabajadas.toFixed(1) : '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="openEditModal('${row.fecha}')">âœï¸</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('historicTableContainer').innerHTML = html;
        }

        function updateHistoricTableMonths(data) {
            const monthlyData = {};
            const monthsWithObservations = new Set();
            
            data.forEach(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                if (!monthlyData[mesAnio]) {
                    monthlyData[mesAnio] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                monthlyData[mesAnio].ingresos += d.ingresos_dia || 0;
                monthlyData[mesAnio].servicios += d.servicios_dia || 0;
                monthlyData[mesAnio].horas += d.horas_trabajadas || 0;
                monthlyData[mesAnio].dias += 1;
                
                if (d.observacions && d.observacions.trim() !== '') {
                    monthsWithObservations.add(mesAnio);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Ingressos</th>
                            <th>Mitjana/dia</th>
                            <th>Mitjana/hora</th>
                            <th>â‚¬/Servei</th>
                            <th>Serveis</th>
                            <th>Dies</th>
                            <th>Hores</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMonths.forEach(mesAnio => {
                const mData = monthlyData[mesAnio];
                const [year, month] = mesAnio.split('-');
                const monthName = monthNames[month];
                
                const mediaDia = mData.dias > 0 ? mData.ingresos / mData.dias : 0;
                const mediaServicio = mData.servicios > 0 ? mData.ingresos / mData.servicios : 0;
                const mediaHora = mData.horas > 0 ? mData.ingresos / mData.horas : 0;
                
                const mediaDiaColor = getConditionalColor(mediaDia, 50, 300);
                const mediaHoraColor = getConditionalColor(mediaHora, 10, 27);
                const monthRevenueColor = getMonthlyRevenueColor(mData.ingresos);
                const hasObservations = monthsWithObservations.has(mesAnio);

                html += `
                    <tr>
                        <td><strong>${monthName} ${year}</strong></td>
                        <td>
                            <strong style="color: ${monthRevenueColor}">${formatCurrency(roundTo5Cents(mData.ingresos))}</strong>
                            ${hasObservations ? '<span class="observation-alert">*</span>' : ''}
                        </td>
                        <td style="color: ${mediaDiaColor}">${formatCurrency(roundTo5Cents(mediaDia))}</td>
                        <td style="color: ${mediaHoraColor}">${mData.horas > 0 ? formatCurrency(roundTo5Cents(mediaHora)) : '-'}</td>
                        <td>${formatCurrency(roundTo5Cents(mediaServicio))}</td>
                        <td>${mData.servicios}</td>
                        <td>${mData.dias}</td>
                        <td>${mData.horas > 0 ? mData.horas.toFixed(1) : '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('historicTableContainer').innerHTML = html;
        }

        // ==========================================
        // COMPARISON VIEW
        // ==========================================
        function updateComparisonView() {
            const startMonth = document.getElementById('comparisonStartMonth').value;
            const endMonth = document.getElementById('comparisonEndMonth').value;
            const filtered = allData.filter(d => {
                const mesAnio = d.mes_anio || d.fecha.substring(0, 7);
                return mesAnio >= startMonth && mesAnio <= endMonth;
            });

            const yearlyData = {};
            filtered.forEach(d => {
                const year = d.fecha.substring(0, 4);
                const month = d.fecha.substring(5, 7);
                
                if (!yearlyData[year]) yearlyData[year] = {};
                if (!yearlyData[year][month]) {
                    yearlyData[year][month] = { ingresos: 0, servicios: 0, horas: 0, dias: 0 };
                }
                
                yearlyData[year][month].ingresos += d.ingresos_dia || 0;
                yearlyData[year][month].servicios += d.servicios_dia || 0;
                yearlyData[year][month].horas += d.horas_trabajadas || 0;
                yearlyData[year][month].dias += 1;
            });

            const years = Object.keys(yearlyData).sort();
            const months = [...new Set(filtered.map(d => d.fecha.substring(5, 7)))].sort();
            const labels = months.map(m => monthNames[m]);

            updateComparisonChart('comparisonChartIngresos', 'Ingressos per mes', labels, years, yearlyData, 'ingresos');
            updateComparisonChart('comparisonChartMediaDia', 'Mitjana diÃ ria per mes', labels, years, yearlyData, 'mediaDia');
            updateComparisonChart('comparisonChartHora', 'â‚¬/Hora per mes', labels, years, yearlyData, 'hora');
        }

        function updateComparisonChart(canvasId, title, labels, years, yearlyData, metric) {
            const ctx = document.getElementById(canvasId);
            const colors = ['#ffc107', '#4caf50', '#2196f3', '#ff4444', '#9c27b0'];
            
            const datasets = years.map((year, index) => {
                const data = labels.map((label, idx) => {
                    const monthNum = Object.keys(monthNames).find(k => monthNames[k] === label);
                    const monthData = yearlyData[year][monthNum];
                    if (!monthData) return 0;
                    if (metric === 'ingresos') {
                        return roundTo5Cents(monthData.ingresos);
                    } else if (metric === 'mediaDia') {
                        return monthData.dias > 0 ? roundTo5Cents(monthData.ingresos / monthData.dias) : 0;
                    } else if (metric === 'hora') {
                        return monthData.horas > 0 ? roundTo5Cents(monthData.ingresos / monthData.horas) : 0;
                    }
                });
                return {
                    label: year,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.4
                };
            });

            if (comparisonCharts[canvasId]) comparisonCharts[canvasId].destroy();

            comparisonCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#b0b0b0' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#404040' },
                            ticks: {
                                color: '#b0b0b0',
                                callback: (value) => formatCurrency(value)
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b0b0b0' }
                        }
                    }
                }
            });
        }

        // ==========================================
        // ALL DAYS TABLE
        // ==========================================
        function updateAllDaysTable() {
            const container = document.getElementById('allDaysTableContainer');
            let html = '<table><thead><tr>';
            html += '<th>Data</th><th>Dia</th><th>Ingressos</th><th>Serveis</th><th>â‚¬/Servei</th><th>Hores</th><th>â‚¬/Hora</th><th>Accions</th>';
            html += '</tr></thead><tbody>';
            
            const sortedData = [...allData].sort((a, b) => b.fecha.localeCompare(a.fecha));
            
            sortedData.forEach(d => {
                const fecha = new Date(d.fecha + 'T12:00:00');
                const diaSemana = diasSemana[fecha.toLocaleDateString('en-US', { weekday: 'long' })] || '';
                const mediaPrecio = d.servicios_dia ? roundTo5Cents(d.ingresos_dia / d.servicios_dia) : 0;
                const mediaHora = d.horas_trabajadas ? roundTo5Cents(d.ingresos_dia / d.horas_trabajadas) : 0;
                
                html += '<tr>';
                html += `<td>${formatDate(d.fecha)}</td>`;
                html += `<td class="weekday-abbr">${diaSemana}</td>`;
                html += `<td>${formatCurrency(d.ingresos_dia)}</td>`;
                html += `<td>${d.servicios_dia}</td>`;
                html += `<td>${formatCurrency(mediaPrecio)}</td>`;
                html += `<td>${d.horas_trabajadas || '-'}</td>`;
                html += `<td>${d.horas_trabajadas ? formatCurrency(mediaHora) : '-'}</td>`;
                html += `<td><button class="btn btn-primary action-btn" onclick="openEditModal('${d.fecha}')">Editar</button></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ==========================================
        // MODALS
        // ==========================================
        function openEditModal(fecha) {
            const data = allData.find(d => d.fecha === fecha);
            if (!data) return;
            currentEditDate = fecha;
            document.getElementById('fechaMonth').value = fecha;
            document.getElementById('ingresosMonth').value = data.ingresos_dia || '';
            document.getElementById('serviciosMonth').value = data.servicios_dia || '';
            document.getElementById('horasMonth').value = data.horas_trabajadas || '';
            document.getElementById('observacionsMonth').value = data.observacions || '';
            document.getElementById('editModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditDate = null;
        }

        function openAddModalForDate(fecha) {
            document.getElementById('fechaMonthAdd').value = fecha;
            document.getElementById('monthModal').classList.add('active');
        }

        function closeMonthModal() {
            document.getElementById('monthModal').classList.remove('active');
            document.getElementById('addDayFormMonthModal').reset();
        }

        async function addNewDay(event, source) {
            event.preventDefault();
            const fechaId = source === 'month' ? 'fechaMonth' : (source === 'monthAdd' ? 'fechaMonthAdd' : 'fecha');
            const ingresosId = source === 'month' ? 'ingresosMonth' : (source === 'monthAdd' ? 'ingresosMonthAdd' : 'ingresos');
            const serviciosId = source === 'month' ? 'serviciosMonth' : (source === 'monthAdd' ? 'serviciosMonthAdd' : 'servicios');
            const horasId = source === 'month' ? 'horasMonth' : (source === 'monthAdd' ? 'horasMonthAdd' : 'horas');
            const observacionsId = source === 'month' ? 'observacionsMonth' : (source === 'monthAdd' ? 'observacionsMonthAdd' : 'observacions');
            
            const fecha = document.getElementById(fechaId).value;
            const ingresos = parseFloat(document.getElementById(ingresosId).value);
            const servicios = parseInt(document.getElementById(serviciosId).value);
            const horas = parseFloat(document.getElementById(horasId).value) || null;
            const observacions = document.getElementById(observacionsId).value.trim() || null;
            
            const newEntry = {
                mes_anio: fecha.substring(0, 7),
                fecha: fecha,
                dia_semana: null,
                semana_num: null,
                ingresos_dia: ingresos,
                servicios_dia: servicios,
                media_precio_servicio: servicios > 0 ? ingresos / servicios : null,
                horas_trabajadas: horas,
                media_ingresos_hora: horas ? ingresos / horas : null,
                observacions: observacions
            };
            
            try {
                const storedData = await getStoredData();
                const storedIndex = storedData.findIndex(d => d.fecha === fecha);
                if (storedIndex >= 0) {
                    storedData[storedIndex] = newEntry;
                    showAlert('Dia actualitzat correctament', 'success', source);
                } else {
                    storedData.push(newEntry);
                    showAlert('Dia afegit correctament', 'success', source);
                }
                
                const saved = await saveToStorage(storedData);
                if (saved) {
                    await loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    resetForm(source);
                    if (source === 'month') {
                        closeModal();
                    }
                    if (source === 'monthAdd') {
                        closeMonthModal();
                    }
                } else {
                    showAlert('Error en desar', 'error', source);
                }
            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Error en desar el dia', 'error', source);
            }
        }

        function resetForm(source) {
            if (source === 'month') {
                document.getElementById('addDayFormMonth').reset();
                document.getElementById('fechaMonth').valueAsDate = new Date();
            } else if (source === 'monthAdd') {
                document.getElementById('addDayFormMonthModal').reset();
            } else {
                document.getElementById('addDayForm').reset();
                document.getElementById('fecha').valueAsDate = new Date();
            }
        }

        function showAlert(message, type, source) {
            const containerId = source === 'month' ? 'alertContainerMonth' : (source === 'monthAdd' ? 'alertContainerMonthAdd' : 'alertContainer');
            const container = document.getElementById(containerId);
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        async function deleteDay(fecha) {
            if (!confirm(`EstÃ s segur que vols eliminar el dia ${formatDate(fecha)}?`)) return;
            try {
                const storedData = await getStoredData();
                const filteredStorage = storedData.filter(d => d.fecha !== fecha);
                const saved = await saveToStorage(filteredStorage);
                if (saved) {
                    await loadData();
                    populateYearFilters();
                    updateDashboard();
                    updateMonthlyView();
                    updateHistoricView();
                    updateAllDaysTable();
                    closeModal();
                    closeMonthModal();
                    showAlert('Dia eliminat correctament', 'success', 'add');
                } else {
                    showAlert('Error en eliminar el dia', 'error', 'add');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                showAlert('Error en eliminar el dia', 'error', 'add');
            }
        }

        // ==========================================
        // EXPORT/IMPORT
        // ==========================================
        async function exportJSON() {
            const storedData = await getStoredData();
            const dataStr = JSON.stringify(storedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facturacio_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error('Format invÃ lid');
                    const saved = await saveToStorage(importedData);
                    if (saved) {
                        await loadData();
                        populateYearFilters();
                        updateDashboard();
                        updateMonthlyView();
                        updateHistoricView();
                        updateAllDaysTable();
                        alert(`Dades importades: ${importedData.length} registres`);
                    } else {
                        alert('Error en desar les dades');
                    }
                } catch (error) {
                    console.error('Error importing:', error);
                    alert('Error en importar les dades');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentMonthView.setMonth(currentMonthView.getMonth() - 1);
            updateDiesView();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentMonthView.setMonth(currentMonthView.getMonth() + 1);
            updateDiesView();
        });

        // ==========================================
        // INITIALIZATION
        // ==========================================
        async function initApp() {
            try {
                await initDB();
                
                const response = await fetch('https://raw.githubusercontent.com/rogerboullosa/facturacion/refs/heads/main/taxi_data_updated.json');
                datosIniciales = await response.json();
            } catch (error) {
                console.error('Error loading initial data:', error);
                datosIniciales = [];
            }
            
            await loadData();
            populateYearFilters();
            updateDashboard();
            updateDiesView();
            updateMesosView();
            updateHistoricView();
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('fechaMonth').valueAsDate = new Date();
            
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }, 500);
        }

        initApp();
    </script>
</body>
</html>
