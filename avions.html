<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCN ARRIBADES</title>
    
    <!-- Iconos y theme color -->
    <link rel="icon" type="image/png" href="avions.png">
    <link rel="apple-touch-icon" href="avions.png">
    <meta name="theme-color" content="#ffc107">
    
    <!-- üé® CAMBIA EL CSS AQU√ç: style1.css / style2.css / style3.css / style4.css / style5.css -->
    <link rel="stylesheet" href="style2.css">
    
</head>
<body>
    <div class="container">
        <div class="header-block">
        <!-- Barra superior solo con configuraci√≥n -->
        <div class="top-bar">
            <div class="config-icon" id="configBtn" title="Configuraci√≥n">‚öôÔ∏è</div>
        </div>
        
        <h1>‚úà BCN ARRIBADES</h1>
        <div class="current-time" id="currentTime">20:13</div>
        </div>
        
        <!-- Panel de configuraci√≥n (oculto por defecto) -->
        <div class="config-panel" id="configPanel">
            <input type="text" id="apiKeyInput" placeholder="RapidAPI Key" value="">
            <div class="config-buttons">
                <button class="primary-button" id="loadFlightsBtn">CARGAR VUELOS</button>
                <button class="secondary-button" id="testApiBtn">PROBAR API</button>
                <button class="secondary-button" id="clearCacheBtn">LIMPIAR CACH√â</button>
                <button class="secondary-button" id="debugBtn">DEBUG</button>
            </div>
            <div class="status-message" id="apiStatus">
                Introduce tu API Key en configuraci√≥n
            </div>
            <div id="debugPanel" class="debug-info" style="display: none;"></div>
        </div>
        
        <div class="stats-bar" id="statsBar" style="display: none;">
            <span class="cache-badge" id="cacheBadge" style="display: none;">üì¶ CACH√â</span>
        </div>
        
        <div id="flightsContainer">
            <div class="empty-state" id="emptyState">
                <p>‚úà Carga los datos para ver el split de terminales</p>
                <p style="font-size: 12px; margin-top: 10px;">FILTRE CODESHARE ACTIU ¬∑ M√ÄXIM 100 VDLS PER API</p>
            </div>
        </div>
        
        <div class="footer">
            <!-- <p>AeroDataBox via RapidAPI ¬∑ Plan gratuito: 500/mes</p> -->
            <p id="cacheInfo" style="font-size: 10px; color: #333333;"></p>
        </div>
    </div>
    
    <script>
        (function() {
            // Elementos DOM
            const configBtn = document.getElementById('configBtn');
            const configPanel = document.getElementById('configPanel');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const loadBtn = document.getElementById('loadFlightsBtn');
            const testBtn = document.getElementById('testApiBtn');
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            const debugBtn = document.getElementById('debugBtn');
            const apiStatus = document.getElementById('apiStatus');
            const statsBar = document.getElementById('statsBar');
            const flightsContainer = document.getElementById('flightsContainer');
            const emptyState = document.getElementById('emptyState');
            const cacheBadge = document.getElementById('cacheBadge');
            const cacheInfo = document.getElementById('cacheInfo');
            const debugPanel = document.getElementById('debugPanel');
            const currentTimeEl = document.getElementById('currentTime');
            
            // Constantes
            const RAPIDAPI_HOST = 'aerodatabox.p.rapidapi.com';
            const AIRPORT = 'BCN';
            const CACHE_KEY = 'aerodatabox_flights_cache';
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
            
            // Variable para depuraci√≥n
            let lastRawData = null;
            let lastProcessedData = null;
            
            // Variable para almacenar las franjas horarias actuales
            let currentTimeSlots = [];
            
            // Toggle panel de configuraci√≥n
            configBtn.addEventListener('click', () => {
                configPanel.classList.toggle('visible');
            });
            
            // Actualizar hora actual
            function updateCurrentTime() {
                const ahora = new Date();
                const horas = ahora.getHours().toString().padStart(2, '0');
                const minutos = ahora.getMinutes().toString().padStart(2, '0');
                currentTimeEl.textContent = `${horas}:${minutos}`;
            }
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            // Generar franjas horarias desde la hora actual hasta 10 horas despu√©s
            function generateTimeSlotsFromNow() {
                const ahora = new Date();
                const horaActual = ahora.getHours();
                const slots = [];
                
                // Generar 11 franjas (hora actual + 10 horas)
                for (let i = 0; i <= 10; i++) {
                    let hora = (horaActual + i) % 24;
                    slots.push(`${hora.toString().padStart(2, '0')}:00`);
                }
                
                return slots;
            }
            
            // Actualizar franjas horarias
            function updateTimeSlots() {
                currentTimeSlots = generateTimeSlotsFromNow();
            }
            
            // Inicializar franjas
            updateTimeSlots();
            
            // Utilidades
            function formatDateForAPI(date) {
                return date.toISOString().split('T')[0];
            }
            
            function formatTimeForAPI(date) {
                return date.toTimeString().split(' ')[0].substring(0,5);
            }
            
            function getHourFromDate(dateString) {
                if (!dateString) return null;
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return null;
                return date.getHours();
            }
            
            // EXTRAER HORA DE LLEGADA
            function extractArrivalTime(flight) {
                if (flight.movement && flight.movement.scheduledTime) {
                    if (typeof flight.movement.scheduledTime === 'object') {
                        return flight.movement.scheduledTime.local || flight.movement.scheduledTime.utc;
                    }
                    return flight.movement.scheduledTime;
                }
                return null;
            }
            
            // EXTRAER AEROPUERTO DE ORIGEN
            function extractOrigin(flight) {
                if (flight.movement && flight.movement.airport) {
                    return {
                        iata: flight.movement.airport.iata || '???',
                        name: flight.movement.airport.name || 'Desconocido'
                    };
                }
                return { iata: '???', name: 'Desconocido' };
            }
            
            // EXTRAER TERMINAL
            function extractTerminal(flight) {
                if (flight.movement && flight.movement.terminal) {
                    return flight.movement.terminal;
                }
                return '1';
            }
            
            // Guardar en cach√©
            function saveToCache(data) {
                const cacheData = {
                    timestamp: Date.now(),
                    flights: data,
                    timeSlots: currentTimeSlots
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                updateCacheInfo();
            }
            
            // Obtener de cach√©
            function getFromCache() {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;
                
                try {
                    const cacheData = JSON.parse(cached);
                    const now = Date.now();
                    
                    if (now - cacheData.timestamp < CACHE_DURATION) {
                        if (cacheData.timeSlots) {
                            currentTimeSlots = cacheData.timeSlots;
                        }
                        return cacheData.flights;
                    } else {
                        localStorage.removeItem(CACHE_KEY);
                        return null;
                    }
                } catch (e) {
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
            }
            
            // Actualizar info de cach√©
            function updateCacheInfo() {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    try {
                        const cacheData = JSON.parse(cached);
                        const expiresIn = Math.round((CACHE_DURATION - (Date.now() - cacheData.timestamp)) / 60000);
                        if (expiresIn > 0) {
                            cacheInfo.textContent = `CACH√â EXPIRA EN ${expiresIn} MIN`;
                        } else {
                            cacheInfo.textContent = '';
                        }
                    } catch (e) {
                        cacheInfo.textContent = '';
                    }
                } else {
                    cacheInfo.textContent = '';
                }
            }
            
            // Eliminar duplicados de c√≥digo compartido
            function removeCodeshareDuplicates(flights) {
                if (!flights || flights.length === 0) return { unique: [], duplicateCount: 0 };
                
                const uniqueFlights = new Map();
                let duplicateCount = 0;
                
                flights.forEach((flight) => {
                    const origin = extractOrigin(flight);
                    const timeStr = extractArrivalTime(flight);
                    
                    if (!timeStr) return;
                    
                    const originCode = origin.iata;
                    
                    let timeDate;
                    try {
                        const cleanTimeStr = timeStr.replace('+01:00', '').replace('Z', '');
                        timeDate = new Date(cleanTimeStr);
                    } catch (e) {
                        return;
                    }
                    
                    if (isNaN(timeDate.getTime())) return;
                    
                    const roundedTime = new Date(timeDate);
                    roundedTime.setSeconds(0, 0);
                    
                    const key = `${originCode}_${roundedTime.getTime()}`;
                    
                    if (!uniqueFlights.has(key)) {
                        uniqueFlights.set(key, flight);
                    } else {
                        duplicateCount++;
                    }
                });
                
                return {
                    unique: Array.from(uniqueFlights.values()),
                    duplicateCount: duplicateCount
                };
            }
            
            // Agrupar vuelos por hora y terminal
            function groupFlightsByTimeSlots(flights) {
                const slots = {};
                currentTimeSlots.forEach(slot => {
                    slots[slot] = { t1: 0, t2: 0 };
                });
                
                flights.forEach(flight => {
                    const timeStr = extractArrivalTime(flight);
                    if (!timeStr) return;
                    
                    const hour = getHourFromDate(timeStr);
                    if (hour === null) return;
                    
                    const slotKey = `${hour.toString().padStart(2, '0')}:00`;
                    
                    if (slots[slotKey]) {
                        const terminal = extractTerminal(flight);
                        const terminalNorm = terminal.toString().trim();
                        
                        if (terminalNorm === '2' || terminalNorm === 'T2') {
                            slots[slotKey].t2++;
                        } else {
                            slots[slotKey].t1++;
                        }
                    }
                });
                
                return slots;
            }
            
            // Mostrar la tabla
            function displayTimeSlots(flights, fromCache = false, originalCount = null) {
                if (!flights || flights.length === 0) {
                    flightsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No hay datos disponibles</p>
                            <p style="font-size: 12px; margin-top: 10px;">FILTRE CODESHARE ACTIU ¬∑ M√ÄXIM 100 VDLS PER API</p>
                        </div>
                    `;
                    statsBar.style.display = 'flex';
                    return;
                }
                
                // Eliminar duplicados
                const { unique: uniqueFlights, duplicateCount } = removeCodeshareDuplicates(flights);
                lastProcessedData = uniqueFlights;
                
                const slots = groupFlightsByTimeSlots(uniqueFlights);
                
                statsBar.style.display = 'flex';
                
                if (fromCache) {
                    cacheBadge.style.display = 'inline-block';
                } else {
                    cacheBadge.style.display = 'none';
                }
                
                
                // Construir tabla
                let tableHTML = `
                    <div class="terminal-header">
                        <div>üïê HORA</div>
                        <div>T1</div>
                        <div>T2</div>
                    </div>
                `;
                
                currentTimeSlots.forEach(slot => {
                    const counts = slots[slot] || { t1: 0, t2: 0 };
                    tableHTML += `
                        <div class="table-row">
                            <div>${slot}</div>
                            <div>${counts.t1}</div>
                            <div>${counts.t2}</div>
                        </div>
                    `;
                });
                
                tableHTML += `
                    <div class="footer-note">
                        ‚úî FILTRE CODESHARE ACTIU ¬∑ M√ÄXIM 100 VDLS PER API
                    </div>
                `;
                
                flightsContainer.innerHTML = tableHTML;
            }
            
            // Mostrar debug
            function showDebugInfo() {
                let debugText = '';
                
                if (lastRawData) {
                    debugText += `TOTAL API: ${lastRawData.length}\n\n`;
                    
                    const samples = lastRawData.slice(0, 3).map(f => ({
                        movement: f.movement ? {
                            airport: f.movement.airport?.iata,
                            time: f.movement.scheduledTime,
                            terminal: f.movement.terminal
                        } : null,
                        airline: f.airline?.name,
                        number: f.number
                    }));
                    
                    debugText += 'PRIMEROS 3:\n';
                    debugText += JSON.stringify(samples, null, 2);
                    
                    if (lastProcessedData) {
                        debugText += `\n\n√öNICOS: ${lastProcessedData.length}`;
                    }
                    
                    debugText += `\n\nFRANJAS HORARIAS ACTUALES:\n`;
                    debugText += currentTimeSlots.join(', ');
                } else {
                    debugText = 'Sin datos cargados';
                }
                
                debugPanel.textContent = debugText;
                debugPanel.style.display = 'block';
            }
            
            // Probar API
            async function testApiKey() {
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    apiStatus.textContent = '‚ùå Introduce API Key';
                    return false;
                }
                
                apiStatus.textContent = '‚è≥ Verificando...';
                
                try {
                    const ahora = new Date();
                    const dentro1h = new Date(ahora.getTime() + 1 * 60 * 60 * 1000);
                    
                    const fromLocal = `${formatDateForAPI(ahora)}T${formatTimeForAPI(ahora)}`;
                    const toLocal = `${formatDateForAPI(dentro1h)}T${formatTimeForAPI(dentro1h)}`;
                    
                    const url = `https://aerodatabox.p.rapidapi.com/flights/airports/iata/BCN/${fromLocal}/${toLocal}`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'X-RapidAPI-Key': apiKey,
                            'X-RapidAPI-Host': RAPIDAPI_HOST
                        }
                    });
                    
                    if (response.status === 401) throw new Error('API Key inv√°lida');
                    if (response.status === 429) throw new Error('L√≠mite alcanzado');
                    if (!response.ok) throw new Error(`Error ${response.status}`);
                    
                    apiStatus.textContent = '‚úÖ API Key v√°lida';
                    localStorage.setItem('aerodatabox_key', apiKey);
                    
                    return true;
                    
                } catch (error) {
                    apiStatus.textContent = `‚ùå ${error.message}`;
                    return false;
                }
            }
            
            // Cargar vuelos (10 horas)
            async function loadFlights() {
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    apiStatus.textContent = '‚ùå Introduce API Key';
                    return;
                }
                
                try {
                    const ahora = new Date();
                    const dentro10h = new Date(ahora.getTime() + 10 * 60 * 60 * 1000);
                    
                    const fromLocal = `${formatDateForAPI(ahora)}T${formatTimeForAPI(ahora)}`;
                    const toLocal = `${formatDateForAPI(dentro10h)}T${formatTimeForAPI(dentro10h)}`;
                    
                    const url = `https://aerodatabox.p.rapidapi.com/flights/airports/iata/BCN/${fromLocal}/${toLocal}`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'X-RapidAPI-Key': apiKey,
                            'X-RapidAPI-Host': RAPIDAPI_HOST
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) throw new Error('API Key inv√°lida');
                        if (response.status === 429) throw new Error('L√≠mite alcanzado');
                        throw new Error(`Error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    let arrivals = [];
                    if (Array.isArray(data)) {
                        arrivals = data;
                    } else if (data && data.arrivals) {
                        arrivals = data.arrivals;
                    }
                    
                    lastRawData = arrivals;
                    
                    if (arrivals.length === 0) {
                        flightsContainer.innerHTML = `
                            <div class="empty-state">
                                <p>No hay vuelos programados</p>
                                <p style="font-size: 12px; margin-top: 10px;">FILTRE CODESHARE ACTIU ¬∑ M√ÄXIM 100 VDLS PER API</p>
                            </div>
                        `;
                        statsBar.style.display = 'flex';
                        return;
                    }
                    
                    updateTimeSlots();
                    saveToCache(arrivals);
                    displayTimeSlots(arrivals, false, arrivals.length);
                    
                    apiStatus.textContent = '‚úÖ Datos cargados';
                    
                    // Ocultar panel de configuraci√≥n autom√°ticamente
                    configPanel.classList.remove('visible');
                    
                } catch (error) {
                    apiStatus.textContent = `‚ùå ${error.message}`;
                }
            }
            
            // Limpiar cach√©
            function clearCache() {
                localStorage.removeItem(CACHE_KEY);
                cacheBadge.style.display = 'none';
                cacheInfo.textContent = '';
                apiStatus.textContent = 'üóëÔ∏è Cach√© limpiado';
                
                flightsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>‚úà Carga los datos para ver el split de terminales</p>
                        <p style="font-size: 12px; margin-top: 10px;">FILTRE CODESHARE ACTIU ¬∑ M√ÄXIM 100 VDLS PER API</p>
                    </div>
                `;
                statsBar.style.display = 'none';
                debugPanel.style.display = 'none';
            }
            
            // Cargar datos de cach√© autom√°ticamente al iniciar
            function loadCachedDataOnStart() {
                const cachedFlights = getFromCache();
                if (cachedFlights && cachedFlights.length > 0) {
                    displayTimeSlots(cachedFlights, true, cachedFlights.length);
                    apiStatus.textContent = 'üì¶ Datos cargados de cach√©';
                    
                    const savedKey = localStorage.getItem('aerodatabox_key');
                    if (savedKey) {
                        apiKeyInput.value = savedKey;
                    }
                } else {
                    const savedKey = localStorage.getItem('aerodatabox_key');
                    if (savedKey) {
                        apiKeyInput.value = savedKey;
                        apiStatus.textContent = 'API Key cargada. Usa "CARGAR VUELOS" para obtener datos.';
                    }
                }
            }
            
            // Event listeners
            loadBtn.addEventListener('click', loadFlights);
            testBtn.addEventListener('click', testApiKey);
            clearCacheBtn.addEventListener('click', clearCache);
            debugBtn.addEventListener('click', showDebugInfo);
            
            loadCachedDataOnStart();
            
            setInterval(updateCacheInfo, 60000);
            updateCacheInfo();
        })();
    </script>
</body>
</html>
